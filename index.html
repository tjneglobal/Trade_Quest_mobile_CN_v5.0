<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Trade Quest v5.0 | æµç¨‹ä»¿çœŸ + ä¸šåŠ¡èƒ½åŠ›ç”»åƒ</title>
  <script src="https://unpkg.com/@phosphor-icons/web"></script>
  <style>
    :root{
      --primary:#0f172a;
      --secondary:#334155;
      --accent:#2563eb;
      --success:#059669;
      --warning:#d97706;
      --danger:#dc2626;

      --bg-body:#f1f5f9;
      --bg-card:#ffffff;
      --text-main:#1e293b;
      --text-muted:#64748b;
      --border:#e2e8f0;
      --radius:10px;
      --shadow:0 6px 14px -8px rgba(0,0,0,.25);

      --sidebar-w:340px;
    }

    *{box-sizing:border-box;margin:0;padding:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";}
    body{background:var(--bg-body);color:var(--text-main);display:flex;flex-direction:column;height:100vh;overflow:hidden;}

    header{
      background:var(--primary); color:#fff;
      height:60px; padding:0 18px;
      display:flex; align-items:center; justify-content:space-between;
      flex-shrink:0; z-index:30;
    }
    .brand{display:flex;align-items:center;gap:10px;font-weight:800;font-size:18px;}
    .brand small{font-weight:500;opacity:.75}
    .session-info{
      display:flex;align-items:center;gap:12px;
      font-size:13px;
      background:rgba(255,255,255,.10);
      padding:6px 10px;border-radius:999px;
    }
    .action-badge{
      background:var(--accent); color:#fff;
      padding:2px 10px;border-radius:6px;
      font-weight:800; font-size:12px;
    }
    .top-btn{
      background:transparent;border:0;color:#fff;opacity:.85;
      cursor:pointer;font-size:14px;
      padding:6px 8px;border-radius:8px;
    }
    .top-btn:hover{opacity:1;background:rgba(255,255,255,.10);}

    #app-container{display:flex;flex:1;overflow:hidden;position:relative;}

    aside{
      width:var(--sidebar-w);
      background:var(--bg-card);
      border-right:1px solid var(--border);
      display:flex;flex-direction:column;flex-shrink:0;z-index:20;
    }
    .sidebar-section{padding:14px;border-bottom:1px solid var(--border);}
    .section-title{
      font-size:12px;text-transform:uppercase;letter-spacing:.08em;
      color:var(--text-muted);font-weight:900;margin-bottom:10px;
      display:flex;justify-content:space-between;align-items:center;
    }
    .stat-row{display:flex;justify-content:space-between;font-size:13px;margin-bottom:6px;}
    .stat-val{font-weight:800;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;}

    .cap-bar-container{display:flex;align-items:center;gap:10px;margin-bottom:8px;font-size:12px;}
    .cap-label{width:96px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;color:var(--secondary);font-weight:700;}
    .cap-track{flex:1;height:6px;background:#e2e8f0;border-radius:999px;overflow:hidden;}
    .cap-fill{height:100%;background:var(--accent);transition:width .25s;}
    .cap-fill.neg{background:var(--danger);}

    .log-panel{flex:1;overflow-y:auto;padding:14px;background:#f8fafc;}
    .log-entry{
      font-size:12px;
      padding:10px;
      border-left:4px solid var(--border);
      margin-bottom:10px;
      background:#fff;
      border-radius:0 var(--radius) var(--radius) 0;
      box-shadow:0 1px 0 rgba(0,0,0,.03);
    }
    .log-entry.stage-risk{border-left-color:var(--danger);background:#fef2f2;}
    .log-entry.stage-good{border-left-color:var(--success);background:#f0fdf4;}
    .log-time{font-size:11px;color:var(--text-muted);margin-bottom:4px;}

    main{flex:1;padding:22px;overflow-y:auto;position:relative;}

    .btn{
      border:1px solid transparent;
      padding:10px 14px;border-radius:10px;
      font-weight:800;cursor:pointer;
      font-size:14px;
      display:inline-flex;align-items:center;gap:8px;
    }
    .btn-primary{background:var(--accent);color:#fff;border-color:var(--accent);}
    .btn-primary:hover{filter:brightness(.95);}
    .btn-outline{background:#fff;color:var(--primary);border-color:var(--border);}
    .btn-outline:hover{border-color:var(--accent);}
    .btn-danger{background:var(--danger);color:#fff;border-color:var(--danger);}
    .btn-muted{background:#f1f5f9;color:var(--secondary);border-color:var(--border);}

    .stage-header{display:flex;align-items:center;gap:12px;margin-bottom:18px;}
    .stage-badge{
      background:var(--primary);color:#fff;
      padding:6px 12px;border-radius:999px;
      font-size:12px;font-weight:900;
    }
    .subtle{color:var(--text-muted);font-size:13px;line-height:1.5;}

    .inbox-list{display:grid;gap:12px;}
    .mail-item{
      display:flex;gap:12px;
      padding:14px;background:#fff;border:1px solid var(--border);
      border-radius:var(--radius);
      cursor:pointer;transition:all .18s;
      box-shadow:0 1px 0 rgba(0,0,0,.03);
    }
    .mail-item:hover{border-color:var(--accent);transform:translateY(-2px);box-shadow:var(--shadow);}
    .tag{font-size:11px;padding:2px 8px;border-radius:999px;font-weight:900;text-transform:uppercase;border:1px solid transparent;}
    .tag-success{background:#f0fdf4;color:var(--success);border-color:#bbf7d0;}
    .tag-risk{background:#fef2f2;color:var(--danger);border-color:#fecaca;}
    .tag-standard{background:#eff6ff;color:var(--accent);border-color:#bfdbfe;}
    .tag-low{background:#f8fafc;color:var(--text-muted);border-color:var(--border);}
    .tag-garbage{background:#fff;color:var(--text-muted);border:1px dashed var(--border);}

    .two-col{
      display:grid;grid-template-columns:1fr 360px;gap:18px;
      align-items:start;
    }
    @media(max-width: 1100px){
      .two-col{grid-template-columns:1fr;}
    }

    .panel{
      background:#fff;border:1px solid var(--border);
      border-radius:var(--radius);padding:16px;
      box-shadow:0 1px 0 rgba(0,0,0,.03);
    }

    .issue-card{
      background:#fff;border:1px solid var(--border);
      border-radius:var(--radius);padding:16px;
      box-shadow:0 1px 0 rgba(0,0,0,.03);
      margin-bottom:14px;
    }
    .issue-title{font-weight:900;font-size:16px;margin-bottom:6px;}
    .issue-desc{color:var(--secondary);font-size:13px;line-height:1.55;margin-bottom:12px;}
    .pill{
      display:inline-flex;align-items:center;gap:6px;
      font-size:11px;font-weight:900;border-radius:999px;padding:3px 10px;
      border:1px solid var(--border);background:#f8fafc;color:var(--secondary);
    }
    .pill.L{background:#f8fafc;}
    .pill.M{background:#fff7ed;border-color:#fed7aa;color:#9a3412;}
    .pill.H{background:#fef2f2;border-color:#fecaca;color:#991b1b;}
    .pill.X{background:#111827;border-color:#111827;color:#fff;}

    .choice-grid{display:grid;gap:10px;margin-top:12px;}
    .choice-btn{
      text-align:left;
      background:#fff;border:1px solid var(--border);
      border-radius:var(--radius);
      padding:12px 12px;
      cursor:pointer;transition:all .15s;
    }
    .choice-btn:hover{border-color:var(--accent);transform:translateY(-1px);}
    .choice-title{font-weight:900;margin-bottom:4px;}
    .choice-meta{display:flex;gap:10px;flex-wrap:wrap;font-size:12px;color:var(--text-muted);}

    .modal-overlay{
      position:fixed;inset:0;background:rgba(0,0,0,.5);
      z-index:99;opacity:0;pointer-events:none;
      transition:opacity .2s;
      display:flex;align-items:center;justify-content:center;
      padding:14px;
    }
    .modal-overlay.active{opacity:1;pointer-events:auto;}
    .modal-card{
      background:#fff;width:92%;max-width:760px;
      border-radius:16px;padding:18px;
      box-shadow:0 24px 50px -20px rgba(0,0,0,.45);
      transform:scale(.98);transition:transform .2s;
    }
    .modal-overlay.active .modal-card{transform:scale(1);}
    .summary-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin:14px 0;}
    @media(max-width: 760px){.summary-grid{grid-template-columns:repeat(2,1fr);}}
    .summary-item{background:#f8fafc;border:1px solid var(--border);border-radius:12px;padding:12px;text-align:center;}
    .summary-item .label{font-size:11px;color:var(--text-muted);font-weight:900;text-transform:uppercase;letter-spacing:.06em;}
    .summary-item .value{font-size:18px;font-weight:900;margin-top:6px;}

    #manual-drawer{
      position:fixed;top:0;right:0;width:380px;height:100%;
      background:#fff;box-shadow:-10px 0 30px rgba(0,0,0,.18);
      z-index:98;transform:translateX(100%);
      transition:transform .25s;
      padding:18px;overflow:auto;
    }
    #manual-drawer.open{transform:translateX(0%);}
    #manual-drawer h2{margin-bottom:12px;}
    #manual-drawer p, #manual-drawer li{font-size:13px;line-height:1.6;color:var(--secondary);}
    #manual-drawer ul{padding-left:18px;margin:10px 0;}

    .muted-box{
      background:#fff;border:1px solid var(--border);
      padding:18px;border-radius:var(--radius);
      text-align:center;
    }

    .good{color:var(--success);font-weight:900;}
    .bad{color:var(--danger);font-weight:900;}
 /* ===============================
   ğŸ“± Mobile Responsive Support
   =============================== */

@media (max-width: 768px){

  body{
    overflow: hidden;
  }

  #app-container{
    flex-direction: column;
  }

  /* Sidebar â†’ æŠ½å±‰ */
  aside{
    position: fixed;
    top: 60px; /* header é«˜åº¦ */
    left: 0;
    height: calc(100vh - 60px);
    width: 88%;
    max-width: 360px;
    transform: translateX(-100%);
    transition: transform .25s ease;
    box-shadow: 10px 0 30px rgba(0,0,0,.25);
    z-index: 90;
  }

  aside.mobile-open{
    transform: translateX(0%);
  }

  /* ä¸»å†…å®¹å…¨å®½ */
  main{
    padding: 14px;
    width: 100%;
  }

  /* Header å‹ç¼© */
  header{
    padding: 0 12px;
  }

  .brand small{
    display: none;
  }

  .session-info{
    display: none;
  }

  /* Modal åœ¨æ‰‹æœºæ›´å‹å¥½ */
  .modal-card{
    width: 100%;
    max-width: none;
    border-radius: 14px;
  }

  /* å¹´åº¦ç»“ç®—ä¸¤åˆ— â†’ ä¸€åˆ— */
  .two-col{
    grid-template-columns: 1fr !important;
  }
} 

</style>
</head>
<body>
<header>
  <div class="brand">
  <button class="top-btn" onclick="ui.toggleSidebar()" style="font-size:18px">â˜°</button>
  <i class="ph ph-cards" style="font-size:22px;color:#60a5fa;"></i>
  Trade Quest <small>v5.0 | æµç¨‹ä»¿çœŸ + ä¸šåŠ¡èƒ½åŠ›ç”»åƒ</small>
</div>

  <div class="session-info">
    <span>Year <b id="disp-year">1</b> â€” Week <b id="disp-week">1</b> / <b id="disp-maxweek">24</b></span>
    <span>|</span>
    <span>Actions: <span id="disp-actions" class="action-badge">5/5</span></span>
  </div>

  <div>
    <button class="top-btn" onclick="ui.toggleManual()">ğŸ“˜ æ“ä½œæŒ‡å—</button>
    <button class="top-btn" onclick="engine.quickSaveToLocal()">ğŸ’¾ ä¿å­˜</button>
    <button class="top-btn" onclick="engine.quickLoadFromLocal()">ğŸ“‚ è¯»å–</button>
    <button class="top-btn" onclick="engine.hardReset()">ğŸ” é‡ç½®</button>
  </div>
</header>

<div id="app-container">
  <aside>
    <div class="sidebar-section">
      <div class="section-title">å½“å‰è®¢å•çŠ¶æ€ <span class="pill" id="ord-pill">â€”</span></div>
      <div class="stat-row"><span>è®¢å• ID</span><span class="stat-val" id="ord-id">--</span></div>
      <div class="stat-row"><span>é˜¶æ®µ</span><span class="stat-val" id="ord-stage">--</span></div>
      <div class="stat-row"><span>é‡‘é¢ï¼ˆæ¨¡æ‹Ÿï¼‰</span><span class="stat-val" id="ord-rev">--</span></div>
      <div class="stat-row"><span>æ¯›åˆ©ç‡</span><span class="stat-val" id="ord-margin">--</span></div>
      <div class="stat-row"><span>ç´¯è®¡å»¶è¯¯</span><span class="stat-val" id="ord-delay">0d</span></div>
      <div class="stat-row"><span>è´¨é‡é£é™©</span><span class="stat-val" id="ord-risk">0</span></div>
      <div class="stat-row"><span>å®¢æˆ·æ»¡æ„</span><span class="stat-val" id="ord-sat">--</span></div>
    </div>

    <div class="sidebar-section">
      <div class="section-title">ä¸šåŠ¡èƒ½åŠ›ç”»åƒ</div>
      <div id="score-radar"></div>
    </div>

    <div class="log-panel">
      <div class="section-title">å†³ç­–æ—¥å¿—</div>
      <div id="log-container"></div>
    </div>
  </aside>

  <main id="main-view"></main>
</div>

<div id="modal-overlay" class="modal-overlay">
  <div class="modal-card" id="modal-content"></div>
</div>

<div id="manual-drawer">
  <h2>ğŸ“˜ æ“ä½œæŒ‡å—ï¼ˆv5.0ï¼‰</h2>
  <p><b>1ï¼‰ç»è¥å‘¨æœŸï¼š</b>æœ¬ç‰ˆæœ¬ä¸º <b>24 å‘¨</b>ï¼Œæ¨¡æ‹Ÿå…¸å‹ 6â€“8 å‘¨ç”Ÿäº§å‘¨æœŸä¸‹çš„å¤šè®¢å•å¹¶è¡Œã€‚</p>
  <p><b>2ï¼‰è¡ŒåŠ¨æœºåˆ¶ï¼š</b>æ¯å‘¨ <b>5 æ¬¡è¡ŒåŠ¨</b>ï¼ˆå·¥ä½œæ—¥æ¯æ—¥ä¸€æ¬¡ï¼‰ã€‚</p>
  <ul>
    <li><b>æ‰“å¼€é‚®ä»¶ / æŸ¥çœ‹ä¿¡æ¯ / åˆ‡æ¢è®¢å•ï¼š</b>ä¸æ¶ˆè€—è¡ŒåŠ¨ç‚¹</li>
    <li><b>ç‚¹å‡»â€œåº”å¯¹å†³ç­–â€é€‰é¡¹ï¼š</b>æ¶ˆè€— 1 æ¬¡è¡ŒåŠ¨ç‚¹</li>
    <li><b>é¡ºåˆ©æ¨è¿›ï¼ˆæ— é—®é¢˜ï¼‰/ è¿›å…¥ä¸‹ä¸€é˜¶æ®µï¼š</b>ä¸æ¶ˆè€—è¡ŒåŠ¨ç‚¹</li>
  </ul>

  <p><b>3ï¼‰çœŸå®ä¸šåŠ¡é“¾è·¯ï¼š</b></p>
  <ul>
    <li>è¯¢å• â†’ ä¸‹å•å‰ï¼ˆåˆåŒè¯„å®¡/æŠ€æœ¯è®¨è®ºï¼‰â†’ é‡‡è´­ â†’ ç”Ÿäº§ â†’ å‘è´§ â†’ è¿è¾“ â†’ æŠ¥å…³ â†’ è®¢å•å®Œæˆ â†’ï¼ˆå¯é€‰ï¼‰å”®å</li>
  </ul>

  <p><b>4ï¼‰ç¯å¢ƒé—®é¢˜æœºåˆ¶ï¼ˆæ ¸å¿ƒï¼‰ï¼š</b></p>
  <ul>
    <li>æ¯ä¸ªç¯èŠ‚éšæœºå‡ºç° <b>0â€“4 ä¸ªé—®é¢˜</b>ï¼Œä¹Ÿå¯èƒ½å®Œå…¨é¡ºåˆ©</li>
    <li>é—®é¢˜æŒ‰é¡ºåºå‘ç”Ÿï¼Œä½ <b>ä¸èƒ½é€‰æ‹©é‡åˆ°å“ªä¸ªé—®é¢˜</b></li>
    <li>ä½ åªèƒ½é€‰æ‹©<b>å¦‚ä½•åº”å¯¹</b>ï¼Œä¸åŒé€‰æ‹©ä¼šå½±å“ï¼šæ¯›åˆ©ã€äº¤æœŸã€é£é™©ã€æ»¡æ„åº¦ä¸èƒ½åŠ›ç”»åƒ</li>
  </ul>

  <p><b>5ï¼‰ä¸¢å•ï¼ˆLostï¼‰ï¼š</b>ä¸¢å•æ˜¯åˆæ³•ç»“å±€ï¼Œä¸æ˜¯â€œå¤±è´¥â€ã€‚çœŸå®ä¸–ç•Œé‡Œè¿™å¾ˆå¸¸è§ã€‚</p>

  <div style="margin-top:14px;text-align:right;">
    <button class="btn btn-outline" onclick="ui.toggleManual()">å…³é—­</button>
  </div>
</div>

<script>
/**
 * =====================================================================
 * Trade Quest v5 | Single-file runnable
 * âœ… æ ¸å¿ƒæœºåˆ¶ï¼š
 * - é€‰é¡¹åˆ—è¡¨é‡Œä¸å±•ç¤ºä»»ä½•æ­£è´Ÿåˆ†/å‚æ•°/æš—ç¤º
 * - ç‚¹å‡»é€‰é¡¹åå¼¹çª—æ­ç¤ºçœŸå®å½±å“ï¼ˆäº¤æœŸÂ±dã€é£é™©ã€æ»¡æ„ã€æ¯›åˆ©ã€ç°é‡‘ç­‰ï¼‰
 * âœ… æœ¬æ¬¡ä¿®å¤/å¢å¼ºï¼ˆæŒ‰ä½ åé¦ˆï¼‰ï¼š
 * 1) è®¢å•è§†å›¾æ–°å¢ï¼šè¿”å›æ”¶ä»¶ç®± + æ”¾å¼ƒè¯¥å®¢æˆ·ï¼ˆä¸»åŠ¨ä¸¢å•ï¼‰
 * 2) æ”¶ä»¶ç®±æ–°å¢ï¼šè¿›è¡Œä¸­è®¢å•åˆ—è¡¨ï¼ˆå¤šè®¢å•å¹¶è¡Œåˆ‡æ¢ï¼Œä¸å½±å“å¼•æ“ï¼‰
 * 3) 24 å‘¨ç»“æŸç»“ç®—é¡µï¼šä¿®å¤å¡ä½ï¼ˆæ–°å¢ renderYearEndï¼Œä¸”ç¬¬24å‘¨ç»“æŸç›´æ¥ç»“ç®—ï¼‰
 * =====================================================================
 */

/* -----------------------------
   0) Utilities
------------------------------ */

function clampNumber(value, minValue, maxValue){
  return Math.max(minValue, Math.min(maxValue, value));
}

function deepCopy(obj){
  return JSON.parse(JSON.stringify(obj));
}

function randomInt(min, max){
  return Math.floor(Math.random() * (max - min + 1)) + min;
}

function randomFloat(min, max){
  return Math.random() * (max - min) + min;
}

function pickOne(array){
  return array[Math.floor(Math.random() * array.length)];
}

function weightedPick(items){
  const total = items.reduce((sum, it) => sum + it.weight, 0);
  let r = Math.random() * total;
  for (const it of items){
    r -= it.weight;
    if (r <= 0) return it.value;
  }
  return items[items.length - 1].value;
}

function formatMoneyUSD(amount){
  const sign = amount < 0 ? "-" : "";
  const abs = Math.abs(amount);
  if (abs >= 1000000) return sign + "$" + (abs/1000000).toFixed(2) + "M";
  if (abs >= 1000) return sign + "$" + (abs/1000).toFixed(1) + "K";
  return sign + "$" + abs.toFixed(0);
}

function formatPercent(value){
  return (value).toFixed(1) + "%";
}

function nowTimeTag(week){
  return "W" + week;
}

function signed(n, digits){
  if (typeof n !== "number" || isNaN(n)) return "0";
  const v = digits!=null ? n.toFixed(digits) : Math.round(n).toString();
  return (n>0?"+":"") + v;
}

/* -----------------------------
   1) Stages & Capability Model
------------------------------ */

const MAX_WEEKS = 24;
const ACTIONS_PER_WEEK = 5;

const STAGES = [
  { key: "inquiry", name: "è¯¢å•" },
  { key: "pre_order", name: "ä¸‹å•å‰ï¼ˆè¯„å®¡/æŠ€æœ¯/åˆåŒï¼‰" },
  { key: "procurement", name: "é‡‡è´­" },
  { key: "manufacturing", name: "ç”Ÿäº§" },
  { key: "shipment_ready", name: "å‘è´§" },
  { key: "transport", name: "è¿è¾“" },
  { key: "customs", name: "æŠ¥å…³/æ¸…å…³" },
  { key: "completion", name: "è®¢å•å®Œæˆ" },
  { key: "after_sales", name: "å”®åï¼ˆå¯é€‰ï¼‰" }
];

const CAPABILITY_KEYS = [
  "lead_qualification",
  "pricing_cost",
  "negotiation",
  "cash_flow",
  "supplier_control",
  "project_planning",
  "quality_bottom_line",
  "risk_judgement"
];

const CAPABILITY_LABELS_CN = {
  lead_qualification: "çº¿ç´¢åˆ¤æ–­",
  pricing_cost: "æŠ¥ä»·æˆæœ¬",
  negotiation: "å•†åŠ¡åšå¼ˆ",
  cash_flow: "èµ„é‡‘å›æ¬¾",
  supplier_control: "ä¾›åº”é“¾æ§",
  project_planning: "é¡¹ç›®è®¡åˆ’",
  quality_bottom_line: "è´¨é‡åº•çº¿",
  risk_judgement: "é£é™©åˆ¤æ–­"
};

function createEmptyScores(){
  const scores = {};
  for (const k of CAPABILITY_KEYS) scores[k] = 0;
  return scores;
}

/* -----------------------------
   2) Inquiry Templates (Inbox generation)
------------------------------ */

const INQUIRY_TEMPLATES = [
  {
    type: "high_quality",
    tagClass: "tag-success",
    label: "é«˜è´¨é‡",
    customerPool: [
      "EU EPC â€” Pipeline Contractor",
      "EU Municipal EPC",
      "North America CP Integrator",
      "Japan Industrial EPC",
      "Korea Water Utility EPC"
    ],
    subjectPool: [
      "Impressed Current CP â€” Pipeline Section",
      "MMO Anode System for Tank Farm",
      "Seawater Electrochlorination Cell Inquiry",
      "Titanium MMO Mesh Anodes for CP",
      "Copper Foil Anode / Dissolution System Upgrade"
    ],
    snippetPool: [
      "è§„æ ¼æ¸…æ™°ã€é¡¹ç›®èŠ‚ç‚¹æ˜ç¡®ï¼Œæ¡æ¬¾å¯è°ˆï¼ŒæŠ€æœ¯æ²Ÿé€šé¡ºç•…ã€‚",
      "EPC èƒŒæ™¯æ˜ç¡®ï¼Œè¯¢å•åŒ…å«å›¾çº¸ä¸å‚æ•°ï¼Œäº¤æœŸè¦æ±‚åˆç†ã€‚",
      "å¯¹è®¤è¯/ææ–™/å¯¿å‘½æœ‰æ˜ç¡®è¦æ±‚ï¼Œæ„¿æ„é…åˆæŠ€æœ¯æ¾„æ¸…ã€‚"
    ],
    weights: { base: 18 }
  },
  {
    type: "standard",
    tagClass: "tag-standard",
    label: "æ ‡å‡†",
    customerPool: [
      "SEA OEM Manufacturer",
      "Middle East EPC Subcontractor",
      "EU Distributor",
      "India Water System Integrator",
      "South America Industrial Buyer"
    ],
    subjectPool: [
      "Platinized Titanium Electrodes â€” repeat order",
      "Tubular MMO Anodes for CP",
      "Electrochlorination Cell â€” budgetary quote",
      "DSA/MMO Anodes â€” general inquiry",
      "Copper Foil Equipment Parts â€” RFQ"
    ],
    snippetPool: [
      "ä¿¡æ¯åŸºæœ¬é½å…¨ï¼Œä½†äº¤æœŸ/ä»˜æ¬¾éœ€è¦è¿›ä¸€æ­¥è°ˆã€‚",
      "æœ‰è¿‡ç±»ä¼¼é‡‡è´­å†å²ï¼Œä½†å¯¹ä»·æ ¼æ•æ„Ÿï¼Œå¯èƒ½å¤šå®¶æ¯”ä»·ã€‚",
      "æŠ€æœ¯ä¸Šä¸å¤æ‚ï¼Œä½†å†…éƒ¨æµç¨‹å¯èƒ½æ…¢ã€‚"
    ],
    weights: { base: 44 }
  },
  {
    type: "risky",
    tagClass: "tag-risk",
    label: "é«˜é£é™©",
    customerPool: [
      "ME Trading Company",
      "Unknown Broker (Middleman)",
      "SEA Trader",
      "â€œProject Agentâ€ (No end-user)",
      "Private Email Buyer"
    ],
    subjectPool: [
      "Need lowest price ASAP",
      "Send full price list and lead time",
      "Net 60/90 payment request",
      "Urgent inquiry â€” no spec yet",
      "Offer needed today"
    ],
    snippetPool: [
      "ä»˜æ¬¾æ¡ä»¶è‹›åˆ»ã€ç»ˆç«¯ä¸æ˜ï¼Œå¯èƒ½å¥—ä»·æˆ–å‹ä»·ã€‚",
      "åªé—®æœ€ä½ä»·ä¸äº¤æœŸï¼Œä¸æ„¿æä¾›è§„æ ¼ä¸åº”ç”¨ç¯å¢ƒã€‚",
      "è¦æ±‚é•¿è´¦æœŸ + äº¤æœŸç´§ï¼Œé£é™©åé«˜ã€‚"
    ],
    weights: { base: 26 }
  },
  {
    type: "low_quality",
    tagClass: "tag-low",
    label: "ä½è´¨é‡",
    customerPool: [
      "Unknown Gmail",
      "Free Mail Address",
      "Generic RFQ Sender",
      "No Company Signature",
      "Unverified Contact"
    ],
    subjectPool: [
      "anode inquiry",
      "price request",
      "electrode supplier?",
      "catalog needed",
      "hello"
    ],
    snippetPool: [
      "ä¿¡æ¯æå°‘ï¼Œç¼ºä¹é¡¹ç›®èƒŒæ™¯ä¸è§„æ ¼ã€‚",
      "åƒæ˜¯ç¾¤å‘è¯¢ç›˜ï¼Œå›å¤ç‡ä¸ç¡®å®šã€‚",
      "ç¼ºå°‘å…¬å¸ä¿¡æ¯ï¼Œç–‘ä¼¼å¥—èµ„æ–™ã€‚"
    ],
    weights: { base: 12 }
  }
];

function generateInboxForWeek(weekNumber){
  const mailCount = randomInt(4, 8);
  const mails = [];

  for (let i = 0; i < mailCount; i++){
    const typePicked = weightedPick([
      { value: "high_quality", weight: INQUIRY_TEMPLATES.find(t => t.type==="high_quality").weights.base },
      { value: "standard", weight: INQUIRY_TEMPLATES.find(t => t.type==="standard").weights.base },
      { value: "risky", weight: INQUIRY_TEMPLATES.find(t => t.type==="risky").weights.base },
      { value: "low_quality", weight: INQUIRY_TEMPLATES.find(t => t.type==="low_quality").weights.base }
    ]);

    const tpl = INQUIRY_TEMPLATES.find(t => t.type === typePicked);

    const customer = pickOne(tpl.customerPool);
    const subject = pickOne(tpl.subjectPool);
    const snippet = pickOne(tpl.snippetPool);

    const productLine = weightedPick([
      { value: "MMO é˜´ä¿", weight: 45 },
      { value: "æ°´å¤„ç†ç”µè§£ï¼ˆæ¬¡æ°¯é…¸é’ /ç”µè§£æ°¯ï¼‰", weight: 22 },
      { value: "é“œç®”è®¾å¤‡/ç³»ç»Ÿ", weight: 18 },
      { value: "é•€é“‚é˜³æ", weight: 15 }
    ]);

    const region = weightedPick([
      { value: "EU", weight: 32 },
      { value: "ME", weight: 18 },
      { value: "SEA", weight: 20 },
      { value: "Korea/Japan", weight: 15 },
      { value: "North America", weight: 15 }
    ]);

    const mailId = "RFQ_W" + weekNumber + "_" + (i+1) + "_" + Math.random().toString(36).slice(2, 6);

    mails.push({
      id: mailId,
      week: weekNumber,
      type: tpl.type,
      tagClass: tpl.tagClass,
      qualityLabel: tpl.label,
      customer: customer,
      region: region,
      productLine: productLine,
      subject: subject,
      snippet: snippet,
      removed: false
    });
  }

  return mails;
}

/* -----------------------------
   3) Issue System (Core)
------------------------------ */

function createChoice(choiceId, title, explanation, effects, scoreDelta, meta){
  return {
    id: choiceId,
    title: title,
    explanation: explanation,
    effects: effects || {},
    scoreDelta: scoreDelta || {},
    meta: meta || {},
    result: (meta && meta.result) ? meta.result : null,
    followups: (meta && meta.followups) ? meta.followups : []
  };
}

function createIssue(issueId, stageKey, title, description, severity, choices, systemTag){
  return {
    id: issueId,
    stageKey: stageKey,
    title: title,
    description: description,
    severity: severity,
    choices: choices || [],
    systemTag: systemTag || null
  };
}

function rollIssueCountForStage(stageKey){
  const base = weightedPick([
    { value: 0, weight: 42 },
    { value: 1, weight: 30 },
    { value: 2, weight: 18 },
    { value: 3, weight: 8 },
    { value: 4, weight: 2 }
  ]);
  if (stageKey === "manufacturing") {
    const bonus = weightedPick([
      { value: 0, weight: 15 },
      { value: 1, weight: 35 },
      { value: 2, weight: 30 },
      { value: 3, weight: 16 },
      { value: 4, weight: 4 }
    ]);
    return bonus;
  }
  if (stageKey === "procurement") {
    const bonus = weightedPick([
      { value: 0, weight: 28 },
      { value: 1, weight: 32 },
      { value: 2, weight: 22 },
      { value: 3, weight: 14 },
      { value: 4, weight: 4 }
    ]);
    return bonus;
  }
  return base;
}

function applyEffects(session, order, effects){
  if (!effects) return;

  if (typeof effects.marginPctDelta === "number") order.vars.marginPct = order.vars.marginPct + effects.marginPctDelta;
  if (typeof effects.delayDaysDelta === "number") order.vars.delayDays = order.vars.delayDays + effects.delayDaysDelta;
  if (typeof effects.qualityRiskDelta === "number") order.vars.qualityRisk = order.vars.qualityRisk + effects.qualityRiskDelta;
  if (typeof effects.cashRiskDelta === "number") order.vars.cashRisk = order.vars.cashRisk + effects.cashRiskDelta;
  if (typeof effects.satisfactionDelta === "number") order.vars.customerSatisfaction = order.vars.customerSatisfaction + effects.satisfactionDelta;
  if (typeof effects.internalFrictionDelta === "number") order.vars.internalFriction = order.vars.internalFriction + effects.internalFrictionDelta;

  if (typeof effects.cashUSDDelta === "number") session.resources.cashUSD = session.resources.cashUSD + effects.cashUSDDelta;
  if (typeof effects.receivablesUSDDelta === "number") session.resources.receivablesUSD = session.resources.receivablesUSD + effects.receivablesUSDDelta;

  if (typeof effects.winChanceDelta === "number") order.vars.winChance = order.vars.winChance + effects.winChanceDelta;
  if (typeof effects.lostChanceDelta === "number") order.vars.lostChance = order.vars.lostChance + effects.lostChanceDelta;

  order.vars.marginPct = clampNumber(order.vars.marginPct, -30, 60);
  order.vars.delayDays = clampNumber(order.vars.delayDays, 0, 365);
  order.vars.qualityRisk = clampNumber(order.vars.qualityRisk, 0, 100);
  order.vars.cashRisk = clampNumber(order.vars.cashRisk, 0, 100);
  order.vars.customerSatisfaction = clampNumber(order.vars.customerSatisfaction, 0, 100);
  order.vars.internalFriction = clampNumber(order.vars.internalFriction, 0, 100);
  order.vars.winChance = clampNumber(order.vars.winChance, 0, 95);
  order.vars.lostChance = clampNumber(order.vars.lostChance, 0, 95);
}

function applyScoreDelta(session, scoreDelta){
  if (!scoreDelta) return;
  for (const [key, delta] of Object.entries(scoreDelta)){
    if (typeof session.scores[key] !== "number") session.scores[key] = 0;
    session.scores[key] = session.scores[key] + delta;
  }
}

/* -----------------------------
   3.1) Issues: buildIssueForStage + followups
   ï¼ˆä¿æŒä½ ä¹‹å‰ç‰ˆæœ¬é€»è¾‘ï¼Œä¸å·æ‡’ï¼šè¿™é‡Œæ˜¯å®Œæ•´å¯è¿è¡Œç‰ˆï¼‰
------------------------------ */

function buildIssueForStage(stageKey, mailContext){
  if (stageKey === "inquiry"){
    const pool = [
      () => createIssue(
        "INQ_INFO_MISSING_" + Math.random().toString(36).slice(2,6),
        "inquiry",
        "å®¢æˆ·ä¿¡æ¯ä¸å®Œæ•´",
        "å®¢æˆ·æœªæä¾›æ˜ç¡®è§„æ ¼æˆ–åº”ç”¨åœºæ™¯ï¼Œæ— æ³•åˆ¤æ–­é˜³æç±»å‹/å¯¿å‘½/ç”µæµå¯†åº¦èŒƒå›´ã€‚è‹¥è´¸ç„¶æŠ¥ä»·ï¼Œåç»­ææ˜“è¿”å·¥æˆ–è¢«åŠ¨æ”¹ä»·ã€‚",
        pickOne(["L","M"]),
        [
          createChoice(
            "INQ_A",
            "è¦æ±‚è¡¥å……è§„æ ¼ä¸åº”ç”¨ç¯å¢ƒï¼ˆä¸æ€¥äºæŠ¥ä»·ï¼‰",
            "å‘å‡ºç»“æ„åŒ–æ¾„æ¸…æ¸…å•ï¼šä»‹è´¨/æ¸©åº¦/ç”µæµ/å°ºå¯¸/å¯¿å‘½/å®‰è£…æ–¹å¼/éªŒæ”¶æ ‡å‡†ã€‚",
            { delayDaysDelta: 2, qualityRiskDelta: -6, satisfactionDelta: -1, winChanceDelta: -2 },
            { lead_qualification: +3, risk_judgement: +2, quality_bottom_line: +2 },
            {}
          ),
          createChoice(
            "INQ_B",
            "åŸºäºç»éªŒç»™å‡ºâ€œå‡è®¾æŠ¥ä»·â€ï¼ˆæŠ¢å…ˆå ä½ï¼‰",
            "å…ˆç»™é¢„ç®—ä»·ä¸å‡è®¾å‰æï¼Œäº‰å–è¿›å…¥å€™é€‰åå•ï¼Œä½†åç»­æ”¹ä»·/æ”¹è§„æ ¼æ¦‚ç‡ä¸Šå‡ã€‚",
            { qualityRiskDelta: +8, winChanceDelta: +3, satisfactionDelta: -2 },
            { pricing_cost: +1, risk_judgement: -2 },
            {}
          ),
          createChoice(
            "INQ_C",
            "åˆ¤æ–­ä¸ºä½ä»·å€¼çº¿ç´¢ï¼Œæš‚ä¸æŠ•å…¥ï¼ˆæ”¾å¼ƒï¼‰",
            "å°†èµ„æºç•™ç»™æ›´æ¸…æ™°çš„è¯¢å•ï¼Œè®°å½•åŸå› å¹¶å½’æ¡£ã€‚",
            { lostChanceDelta: +12 },
            { lead_qualification: +2, project_planning: +1 },
            { result: "lost" }
          )
        ]
      ),
      () => createIssue(
        "INQ_IDENTITY_UNCLEAR_" + Math.random().toString(36).slice(2,6),
        "inquiry",
        "å®¢æˆ·èº«ä»½ä¸æ¸…æ™°ï¼ˆEPC/ç»ˆç«¯/ä¸­é—´å•†ï¼Ÿï¼‰",
        "å¯¹æ–¹è¯æœ¯åƒä¸­é—´å•†ï¼Œä½†åˆæåˆ°ç»ˆç«¯é¡¹ç›®ã€‚è‹¥ä¸æ¾„æ¸…èº«ä»½ï¼Œä»˜æ¬¾ã€éªŒæ”¶ä¸æŠ€æœ¯æ²Ÿé€šå°†éå¸¸ç—›è‹¦ã€‚",
        pickOne(["L","M"]),
        [
          createChoice(
            "INQ2_A",
            "æ ¸å®å…¬å¸èƒŒæ™¯ä¸ç»ˆç«¯ä¿¡æ¯ï¼ˆåšèµ„æ ¼ç¡®è®¤ï¼‰",
            "é€šè¿‡å®˜ç½‘/å…¬å¼€èµ„æ–™/é¡¹ç›®å/LinkedIn/é‚®ç®±åŸŸåç­‰å¿«é€ŸéªŒè¯ï¼Œå¹¶è¦æ±‚æä¾›ç»ˆç«¯/é¡¹ç›®æ–¹ä¿¡æ¯ã€‚",
            { delayDaysDelta: 1, winChanceDelta: -1, qualityRiskDelta: -3 },
            { lead_qualification: +3, risk_judgement: +2 },
            {}
          ),
          createChoice(
            "INQ2_B",
            "ç›´æ¥è¿›å…¥æŠ€æœ¯æ²Ÿé€šä¸æŠ¥ä»·ï¼ˆå…ˆæ‹¿åˆ°éœ€æ±‚ï¼‰",
            "å…ˆæŠŠè§„æ ¼åšå‡ºæ¥ï¼Œå†å€’æ¨èº«ä»½ï¼Œä½†å¯èƒ½è¢«å¥—ä»·æˆ–å‹ä»·ã€‚",
            { qualityRiskDelta: +4, cashRiskDelta: +4, winChanceDelta: +2 },
            { negotiation: +1, risk_judgement: -2 },
            {}
          ),
          createChoice(
            "INQ2_C",
            "æŠŠä»˜æ¬¾æ¡ä»¶ä½œä¸ºç­›é€‰ï¼ˆè¦æ±‚é¢„ä»˜æ¬¾/ä¿¡ç”¨è¯ï¼‰",
            "ç”¨ä»˜æ¬¾æ¡æ¬¾è¿‡æ»¤é«˜é£é™©ä¸­é—´å•†ï¼Œæé«˜äº¤æ˜“è´¨é‡ã€‚",
            { winChanceDelta: -3, cashRiskDelta: -6, satisfactionDelta: -3 },
            { cash_flow: +3, risk_judgement: +2, negotiation: +1 },
            {}
          )
        ]
      )
    ];
    return pickOne(pool)();
  }

  if (stageKey === "pre_order"){
    const pool = [
      () => createIssue(
        "PRE_TECH_AMBIGUITY_" + Math.random().toString(36).slice(2,6),
        "pre_order",
        "æŠ€æœ¯å‚æ•°å­˜åœ¨æ­§ä¹‰ï¼ˆéœ€äºŒæ¬¡ç¡®è®¤ï¼‰",
        "æŠ€æœ¯éƒ¨åé¦ˆï¼šéƒ¨åˆ†å…³é”®å‚æ•°æè¿°ä¸æ¸…ï¼ˆå¦‚ç”µæµå¯†åº¦ã€æ¶‚å±‚ä½“ç³»ã€å¯¿å‘½å‡è®¾ã€å®‰è£…æ–¹å¼ï¼‰ã€‚è‹¥ç›´æ¥è¿›å…¥åˆåŒ/ç”Ÿäº§ï¼Œè¿”å·¥é£é™©æ˜¾è‘—å‡é«˜ã€‚",
        pickOne(["M","H"]),
        [
          createChoice(
            "PRE_A",
            "æš‚åœæ¨è¿›ï¼Œå®ŒæˆäºŒæ¬¡æŠ€æœ¯æ¾„æ¸…",
            "ä¼˜å…ˆæŠŠå…³é”®å‚æ•°â€œé”æ­»â€ï¼Œå‡å°‘åç»­è¿”å·¥ä¸æ‰¯çš®ã€‚",
            { delayDaysDelta: 3, qualityRiskDelta: -10, satisfactionDelta: -2, winChanceDelta: -2 },
            { quality_bottom_line: +3, risk_judgement: +3, project_planning: +1 },
            {}
          ),
          createChoice(
            "PRE_B",
            "å…ˆæŒ‰å½“å‰ç†è§£æ¨è¿›åˆåŒè¯„å®¡ï¼ˆåç»­å†è¡¥ï¼‰",
            "çŸ­æœŸé€Ÿåº¦å¿«ï¼Œä½†åç»­å˜æ›´ææ˜“åƒæ‰åˆ©æ¶¦ä¸äº¤æœŸã€‚",
            { qualityRiskDelta: +12, marginPctDelta: -2, winChanceDelta: +2 },
            { project_planning: -2, risk_judgement: -3, pricing_cost: +1 },
            {}
          ),
          createChoice(
            "PRE_C",
            "ç»„ç»‡å†…éƒ¨è¯„å®¡ä¼šï¼ˆæŠ€æœ¯+ç”Ÿäº§+é‡‡è´­ï¼‰å†å¯¹å¤–ç¡®è®¤",
            "ç”¨ä¸€æ¬¡å†…éƒ¨åŒæ­¥æ¢æ¥æ›´ç¨³å®šçš„äº¤ä»˜ä¸æŠ¥ä»·è¾¹ç•Œã€‚",
            { delayDaysDelta: 2, internalFrictionDelta: +8, qualityRiskDelta: -8 },
            { project_planning: +3, risk_judgement: +2, supplier_control: +1 },
            {}
          )
        ]
      ),
      () => createIssue(
        "PRE_TERMS_CONFLICT_" + Math.random().toString(36).slice(2,6),
        "pre_order",
        "åˆåŒæ¡æ¬¾ä¸å®é™…æ‰§è¡Œèƒ½åŠ›å†²çª",
        "å®¢æˆ·å¸Œæœ›æŠŠéªŒæ”¶ã€è´¨ä¿ã€è¿çº¦è´£ä»»å†™å¾—éå¸¸ä¸¥ã€‚å†…éƒ¨æ‹…å¿ƒä¼šå‡ºç°â€œåšä¸åˆ°çš„æ‰¿è¯ºâ€ã€‚",
        pickOne(["M","H"]),
        [
          createChoice(
            "PRE2_A",
            "æå‰æš´éœ²é£é™©ï¼Œæ¨åŠ¨ä¿®æ”¹æ¡æ¬¾",
            "æŠŠâ€œèƒ½åš/ä¸èƒ½åš/å¯æ¥å—è¾¹ç•Œâ€å†™æ¸…ï¼Œé¿å…åæœŸå¤±æ§ã€‚",
            { winChanceDelta: -3, qualityRiskDelta: -4, cashRiskDelta: -3 },
            { risk_judgement: +3, negotiation: +2, pricing_cost: +1 },
            {}
          ),
          createChoice(
            "PRE2_B",
            "å…ˆç­¾ä¸‹åˆåŒï¼Œå†…éƒ¨å†æƒ³åŠæ³•æ¶ˆåŒ–",
            "çŸ­æœŸæ‹¿å•ï¼Œä½†åç»­é£é™©é«˜åº¦é›†ä¸­åˆ°ç”Ÿäº§ä¸äº¤ä»˜é˜¶æ®µã€‚",
            { winChanceDelta: +2, qualityRiskDelta: +6, cashRiskDelta: +6, internalFrictionDelta: +6 },
            { negotiation: +1, risk_judgement: -3, project_planning: -2 },
            {}
          ),
          createChoice(
            "PRE2_C",
            "æŠŠé«˜é£é™©æ¡æ¬¾è½¬æ¢ä¸ºâ€œä»·æ ¼/äº¤æœŸ/æœåŠ¡â€äº¤æ¢æ¡ä»¶",
            "ç”¨è®©æ­¥äº¤æ¢ï¼ˆæ¯”å¦‚æ›´é«˜ä»·æ ¼æˆ–æ›´å®½äº¤æœŸï¼‰ï¼ŒæŠŠé£é™©æ˜¾æ€§åŒ–ã€‚",
            { marginPctDelta: +2, winChanceDelta: -1, cashRiskDelta: -2 },
            { negotiation: +3, pricing_cost: +2, risk_judgement: +2 },
            {}
          )
        ]
      )
    ];
    return pickOne(pool)();
  }

  if (stageKey === "procurement"){
    const pool = [
      () => createIssue(
        "PROC_PRICE_HIKE_" + Math.random().toString(36).slice(2,6),
        "procurement",
        "åŸææ–™ä»·æ ¼ä¸Šæ¶¨",
        "ä¾›åº”å•†åé¦ˆï¼šå…³é”®åŸææ–™çŸ­æœŸä¸Šæ¶¨ï¼ˆä¾‹å¦‚é’›æ/æ¶‚å±‚ç›¸å…³ææ–™/å¤–ååŠ å·¥å•ä»·ï¼‰ã€‚è¿™ä¼šç›´æ¥æŒ¤å‹æ¯›åˆ©æˆ–å½±å“é‡‡è´­è¿›åº¦ã€‚",
        pickOne(["M","H"]),
        [
          createChoice(
            "PROC_A",
            "æ¥å—æ¶¨ä»·ï¼Œç¡®ä¿äº¤æœŸï¼ˆä¹°æ–™ï¼‰",
            "ä¼˜å…ˆä¿è¯ç”Ÿäº§è®¡åˆ’ä¸äº¤ä»˜çª—å£ï¼Œä½†æ¯›åˆ©è¢«å‹ç¼©ã€‚",
            { marginPctDelta: -3, delayDaysDelta: 0, cashRiskDelta: +6, qualityRiskDelta: -1 },
            { pricing_cost: +1, project_planning: +2, risk_judgement: +1 },
            { followups: ["PROC_CASH_TIGHT_POSSIBLE"] }
          ),
          createChoice(
            "PROC_B",
            "è®¨ä»·è¿˜ä»·å¹¶è°ˆåˆ¤äº¤æœŸ/è´¦æœŸ",
            "ä¸ä¾›åº”å•†è°ˆåˆ¤ï¼šä»·æ ¼ã€ä»˜æ¬¾æ¡ä»¶ã€äº¤æœŸã€è¡¥å¿æ¡æ¬¾ã€‚å¯èƒ½èŠ‚çœæˆæœ¬ï¼Œä½†æœ‰å»¶è¯¯é£é™©ã€‚",
            { marginPctDelta: -1, delayDaysDelta: 3, cashRiskDelta: +2, qualityRiskDelta: 0 },
            { negotiation: +3, supplier_control: +2, risk_judgement: +1 },
            { followups: ["PROC_CASH_TIGHT_POSSIBLE"] }
          ),
          createChoice(
            "PROC_C",
            "æ›´æ¢ä¾›åº”å•†ï¼ˆå¯»æ‰¾æ›¿ä»£ï¼‰",
            "å¯èƒ½æ‹¿åˆ°æ›´ä½æˆæœ¬ï¼Œä½†è´¨é‡æ³¢åŠ¨ä¸æ²Ÿé€šæˆæœ¬ä¸Šå‡ã€‚",
            { marginPctDelta: +1, delayDaysDelta: 7, qualityRiskDelta: +10, cashRiskDelta: +2 },
            { supplier_control: +3, risk_judgement: -1, project_planning: -1 },
            {}
          )
        ]
      ),
      () => createIssue(
        "PROC_SPEC_MISMATCH_" + Math.random().toString(36).slice(2,6),
        "procurement",
        "é‡‡è´­è§„æ ¼ä¸ç”Ÿäº§éœ€æ±‚ä¸å®Œå…¨åŒ¹é…",
        "é‡‡è´­å‘ç°ï¼šæŒ‰å½“å‰æ¸…å•ä¸‹å•ä¼šå¯¼è‡´æŸäº›ææ–™/é›¶ä»¶è§„æ ¼ä¸åŒ¹é…ï¼ˆæˆ–äº¤æœŸå¤ªé•¿ï¼‰ã€‚",
        pickOne(["L","M"]),
        [
          createChoice(
            "PROC2_A",
            "æ‹‰æŠ€æœ¯/ç”Ÿäº§ä¸€èµ·ç¡®è®¤æ¸…å•åå†ä¸‹å•",
            "å…ˆæŠŠè§„æ ¼é”å®šï¼Œå†ç»Ÿä¸€ä¸‹å•ï¼Œå‡å°‘è¿”å·¥ä¸é€€æ¢ã€‚",
            { delayDaysDelta: 2, qualityRiskDelta: -6, internalFrictionDelta: +4 },
            { project_planning: +3, quality_bottom_line: +2, risk_judgement: +2 },
            {}
          ),
          createChoice(
            "PROC2_B",
            "å…ˆä¹°å…³é”®ä»¶ï¼Œéå…³é”®ä»¶åè¡¥",
            "ç”¨æ‹†åˆ†ç­–ç•¥ç¼“è§£äº¤æœŸå‹åŠ›ï¼Œä½†ç®¡ç†å¤æ‚åº¦ä¸Šå‡ã€‚",
            { delayDaysDelta: 1, internalFrictionDelta: +6, cashRiskDelta: +2 },
            { project_planning: +2, cash_flow: +1 },
            {}
          ),
          createChoice(
            "PROC2_C",
            "æŒ‰åŸæ¸…å•ç›´æ¥ä¸‹å•ï¼ˆèµŒåç»­èƒ½åè°ƒï¼‰",
            "çŸ­æœŸå¿«ï¼Œä½†ä¸€æ—¦ä¸åŒ¹é…ä¼šå¼•çˆ†ç”Ÿäº§è¿”å·¥ã€‚",
            { delayDaysDelta: 0, qualityRiskDelta: +8, marginPctDelta: -1 },
            { risk_judgement: -2, project_planning: -2 },
            {}
          )
        ]
      ),
      () => createIssue(
        "PROC_OUTSOURCE_RISK_" + Math.random().toString(36).slice(2,6),
        "procurement",
        "å¤–ååŠ å·¥ç¨³å®šæ€§ä¸ç¡®å®š",
        "éƒ¨åˆ†å·¥åºè®¡åˆ’å¤–åï¼Œä½†å¤–åå‚äº¤æœŸä¸è´¨é‡ç¨³å®šæ€§å­˜åœ¨ä¸ç¡®å®šã€‚",
        pickOne(["M","H"]),
        [
          createChoice(
            "PROC3_A",
            "æŒ‘é€‰æ›´ç¨³å¤–åï¼ˆæˆæœ¬æ›´é«˜ï¼‰",
            "ä¼˜å…ˆç¨³å®šäº¤ä»˜ï¼Œå‡å°‘è¿”å·¥æ¦‚ç‡ã€‚",
            { marginPctDelta: -2, delayDaysDelta: 2, qualityRiskDelta: -6 },
            { supplier_control: +3, risk_judgement: +2, quality_bottom_line: +2 },
            {}
          ),
          createChoice(
            "PROC3_B",
            "æ´¾äºº/è¿œç¨‹é©»åœºç›¯è¿›åº¦ä¸è´¨é‡",
            "å¢åŠ ç®¡ç†æŠ•å…¥ï¼Œç”¨è¿‡ç¨‹æ§åˆ¶æ¢ç»“æœç¡®å®šæ€§ã€‚",
            { internalFrictionDelta: +6, delayDaysDelta: 1, qualityRiskDelta: -4 },
            { supplier_control: +3, project_planning: +2, risk_judgement: +1 },
            {}
          ),
          createChoice(
            "PROC3_C",
            "é€‰æ‹©ä¾¿å®œå¤–åï¼ˆèµŒè¿æ°”ï¼‰",
            "çŸ­æœŸæˆæœ¬ä½ï¼Œä½†è¿”å·¥é£é™©ä¸æŠ•è¯‰æ¦‚ç‡æé«˜ã€‚",
            { marginPctDelta: +2, qualityRiskDelta: +12, satisfactionDelta: -6 },
            { pricing_cost: +2, quality_bottom_line: -3, risk_judgement: -3 },
            {}
          )
        ]
      )
    ];
    return pickOne(pool)();
  }

  if (stageKey === "manufacturing"){
    const pool = [
      () => createIssue(
        "MFG_INCOMING_FAIL_" + Math.random().toString(36).slice(2,6),
        "manufacturing",
        "æ¥æ–™æ£€éªŒå¼‚å¸¸ï¼ˆè´¨é‡ä¸åˆæ ¼ï¼‰",
        "ç”Ÿäº§å‰æ£€éªŒå‘ç°ï¼šåŸææ–™å­˜åœ¨ä¸åˆæ ¼é¡¹ï¼ˆå°ºå¯¸åå·®/æè´¨ä¸è¾¾æ ‡/è¡¨é¢ç¼ºé™·ï¼‰ã€‚è¿™åœ¨çœŸå®åŠ å·¥ä¸­éå¸¸å¸¸è§ã€‚",
        pickOne(["M","H"]),
        [
          createChoice(
            "MFG_A",
            "é€€æ¢è´§å¹¶é‡æ–°é‡‡è´­ï¼ˆè´¨é‡ä¼˜å…ˆï¼‰",
            "è´¨é‡åº•çº¿æ›´ç¨³ï¼Œä½†äº¤æœŸä¼šå—åˆ°å½±å“ã€‚",
            { delayDaysDelta: 10, qualityRiskDelta: -12, marginPctDelta: -1 },
            { quality_bottom_line: +4, risk_judgement: +2, project_planning: +1 },
            {}
          ),
          createChoice(
            "MFG_B",
            "æŒ‘é€‰å¯ç”¨æ‰¹æ¬¡ + å±€éƒ¨è¿”å·¥ï¼ˆæŠ˜ä¸­ï¼‰",
            "é€šè¿‡æŒ‘é€‰ä¸è¿”å·¥æ§åˆ¶æŸå¤±ï¼Œå…¼é¡¾äº¤æœŸä¸è´¨é‡ã€‚",
            { delayDaysDelta: 5, qualityRiskDelta: -4, marginPctDelta: -2 },
            { project_planning: +3, quality_bottom_line: +2, pricing_cost: +1 },
            {}
          ),
          createChoice(
            "MFG_C",
            "è®©æ­¥ä½¿ç”¨ä¸åˆæ ¼æ–™èµ¶äº¤æœŸï¼ˆé«˜é£é™©ï¼‰",
            "çŸ­æœŸäº¤æœŸå¥½çœ‹ï¼Œä½†åç»­æŠ•è¯‰/è¿”ä¿®/èµ”å¿æ¦‚ç‡æ˜¾è‘—ä¸Šå‡ã€‚",
            { delayDaysDelta: 0, qualityRiskDelta: +18, satisfactionDelta: -10, marginPctDelta: +1 },
            { quality_bottom_line: -6, risk_judgement: -4 },
            {}
          )
        ]
      ),
      () => createIssue(
        "MFG_DRAWING_MISMATCH_" + Math.random().toString(36).slice(2,6),
        "manufacturing",
        "å›¾çº¸/æŒ‡æ ‡ç†è§£åå·®ï¼ˆå·²åŠ å·¥æ‰å‘ç°ï¼‰",
        "ç”Ÿäº§è¿‡ç¨‹ä¸­å‘ç°ï¼šå›¾çº¸/æŒ‡æ ‡ä¸å®¢æˆ·æœ€ç»ˆç¡®è®¤ç‰ˆæœ¬å­˜åœ¨åå·®ï¼Œå·²åŠ å·¥éƒ¨åˆ†å¯èƒ½éœ€è¦è¿”å·¥æˆ–æŠ¥åºŸã€‚",
        "H",
        [
          createChoice(
            "MFG2_A",
            "ç«‹å³åœçº¿è¿”å·¥é‡åšï¼ˆæ‰¿æ‹…ä»£ä»·ï¼‰",
            "æŠŠé—®é¢˜æ§åˆ¶åœ¨å‚å†…ï¼Œå‡å°‘å¯¹å¤–æ‰©æ•£ä¸å”®åé£é™©ã€‚",
            { delayDaysDelta: 8, marginPctDelta: -4, qualityRiskDelta: -6, internalFrictionDelta: +4 },
            { quality_bottom_line: +4, risk_judgement: +3, project_planning: +1 },
            {}
          ),
          createChoice(
            "MFG2_B",
            "ä¸å®¢æˆ·åå•†æ¥å—ç°çŠ¶ï¼ˆäº‰å–è±å…ï¼‰",
            "å¯èƒ½çœä¸‹è¿”å·¥ï¼Œä½†å®¢æˆ·æ»¡æ„åº¦ä¸‹é™ä¸”å­˜åœ¨è¿½åŠ æ¡æ¬¾é£é™©ã€‚",
            { delayDaysDelta: 2, satisfactionDelta: -12, qualityRiskDelta: +6 },
            { negotiation: +2, risk_judgement: -2, quality_bottom_line: -2 },
            {}
          ),
          createChoice(
            "MFG2_C",
            "å†…éƒ¨å‡çº§åè°ƒï¼ˆæŠ€æœ¯/é”€å”®/ç”Ÿäº§è”åŠ¨ï¼‰å†å¯¹å¤–ç¡®è®¤",
            "ç”¨ç»„ç»‡ååŒé™ä½æŸå¤±ï¼Œä»£ä»·æ˜¯å†…éƒ¨æ‘©æ“¦ä¸æ—¶é—´ã€‚",
            { delayDaysDelta: 5, internalFrictionDelta: +10, qualityRiskDelta: -3 },
            { project_planning: +3, risk_judgement: +2, supplier_control: +1 },
            {}
          )
        ]
      ),
      () => createIssue(
        "MFG_CAPACITY_CONFLICT_" + Math.random().toString(36).slice(2,6),
        "manufacturing",
        "äº§èƒ½/æ’æœŸå†²çªï¼ˆå¤šå•å¹¶è¡Œï¼‰",
        "å½“å‰ç”Ÿäº§çº¿å·²æœ‰å¤šä¸ªè®¢å•æ’äº§ï¼Œæœ¬è®¢å•äº¤æœŸä¸äº§èƒ½çª—å£å†²çªã€‚ç°å®ä¸­è¿™ç»å¸¸å¯¼è‡´â€œæ…¢æ…¢æ‹–äººâ€ã€‚",
        pickOne(["M","H"]),
        [
          createChoice(
            "MFG3_A",
            "æŒ‰æ’æœŸé¡ºå»¶ï¼Œå¹¶æå‰å¯¹å®¢æˆ·æ²Ÿé€šå»¶æœŸ",
            "é€æ˜æ²Ÿé€šé™ä½çˆ†é›·æ¦‚ç‡ï¼Œä½†å®¢æˆ·æ»¡æ„åº¦ç•¥å—å½±å“ã€‚",
            { delayDaysDelta: 7, satisfactionDelta: -6, qualityRiskDelta: -1 },
            { project_planning: +4, risk_judgement: +2, negotiation: +1 },
            {}
          ),
          createChoice(
            "MFG3_B",
            "æ’å•ç”Ÿäº§ï¼ˆå‹ç¼©å…¶ä»–è®¢å•ï¼‰",
            "çŸ­æœŸè¾¾æˆæœ¬è®¢å•äº¤æœŸï¼Œä½†ä¼šæŠŠé£é™©è½¬ç§»åˆ°å…¶ä»–è®¢å•ä¸è´¨é‡ã€‚",
            { delayDaysDelta: -3, qualityRiskDelta: +10, internalFrictionDelta: +6 },
            { project_planning: -2, risk_judgement: -2 },
            {}
          ),
          createChoice(
            "MFG3_C",
            "ç”³è¯·èµ„æºåè°ƒï¼ˆåŠ ç­/è°ƒçº¿/å¤–åéƒ¨åˆ†ï¼‰",
            "ç”¨èµ„æºæ¢æ—¶é—´ï¼Œæˆæœ¬ä¸Šå‡ä½†é£é™©æ›´å¯æ§ã€‚",
            { delayDaysDelta: 2, marginPctDelta: -2, qualityRiskDelta: -2 },
            { project_planning: +3, supplier_control: +2, risk_judgement: +1 },
            {}
          )
        ]
      ),
      () => createIssue(
        "MFG_PROCESS_DEVIATION_" + Math.random().toString(36).slice(2,6),
        "manufacturing",
        "å·¥è‰ºåå·®å¯¼è‡´è¿”å·¥é£é™©ä¸Šå‡",
        "ç”Ÿäº§ä¸­å‘ç°ï¼šå…³é”®å·¥è‰ºæ­¥éª¤å­˜åœ¨åå·®ï¼ˆå‚æ•°/æ—¶é—´/è¡¨é¢å¤„ç†/æ¶‚å±‚çª—å£ï¼‰ï¼Œå¦‚æœç»§ç»­ç”Ÿäº§å¯èƒ½å¯¼è‡´ä¸€è‡´æ€§é—®é¢˜ã€‚",
        pickOne(["M","H"]),
        [
          createChoice(
            "MFG4_A",
            "åœä¸‹æ¥åšå·¥è‰ºå¤æ ¸ï¼ˆç¨³å®šä¸€è‡´æ€§ï¼‰",
            "ç‰ºç‰²ä¸€ç‚¹æ—¶é—´ï¼Œæ¢æ›´ç¨³è´¨é‡ã€‚",
            { delayDaysDelta: 4, qualityRiskDelta: -8, marginPctDelta: -1 },
            { quality_bottom_line: +3, risk_judgement: +2, project_planning: +1 },
            {}
          ),
          createChoice(
            "MFG4_B",
            "è¾¹åšè¾¹ä¿®ï¼ˆä¿æŒäº§å‡ºï¼‰",
            "é€Ÿåº¦è¾ƒå¿«ï¼Œä½†é£é™©æ§åˆ¶ä¸€èˆ¬ã€‚",
            { delayDaysDelta: 1, qualityRiskDelta: +4, marginPctDelta: 0 },
            { project_planning: +1, risk_judgement: -1 },
            {}
          ),
          createChoice(
            "MFG4_C",
            "ç»§ç»­ç”Ÿäº§ï¼ˆèµŒä¸ä¼šå‡ºé—®é¢˜ï¼‰",
            "çŸ­æœŸä¸å½±å“äº¤æœŸï¼Œä½†ä¸€æ—¦çˆ†é›·ä¼šå¾ˆæƒ¨ã€‚",
            { delayDaysDelta: 0, qualityRiskDelta: +12, satisfactionDelta: -6 },
            { risk_judgement: -3, quality_bottom_line: -4 },
            {}
          )
        ]
      )
    ];
    return pickOne(pool)();
  }

  if (stageKey === "shipment_ready"){
    const pool = [
      () => createIssue(
        "SHIP_PACKING_MISMATCH_" + Math.random().toString(36).slice(2,6),
        "shipment_ready",
        "åŒ…è£…/æ ‡è¯†è¦æ±‚ä¸å®¢æˆ·é¢„æœŸä¸ä¸€è‡´",
        "å‘è´§å‰å¤æ ¸å‘ç°ï¼šå®¢æˆ·å¯¹åŒ…è£…ã€æ ‡ç­¾ã€æè´¨æ ‡è¯†ã€é™„ä»¶æ¸…å•æœ‰ç‰¹æ®Šè¦æ±‚ï¼Œè‹¥ä¸å¤„ç†å¯èƒ½åœ¨éªŒæ”¶æˆ–æ¸…å…³ç¯èŠ‚å‡ºé—®é¢˜ã€‚",
        pickOne(["L","M"]),
        [
          createChoice(
            "SHIP_A",
            "æŒ‰å®¢æˆ·è¦æ±‚è¡¥é½åŒ…è£…ä¸æ ‡è¯†ï¼ˆæ ‡å‡†åŒ–ï¼‰",
            "å¢åŠ ä¸€ç‚¹æˆæœ¬ä¸æ—¶é—´ï¼Œä½†é™ä½åç»­é£é™©ã€‚",
            { delayDaysDelta: 2, marginPctDelta: -0.6, qualityRiskDelta: -2 },
            { project_planning: +2, risk_judgement: +2, quality_bottom_line: +1 },
            {}
          ),
          createChoice(
            "SHIP_B",
            "ä¸å®¢æˆ·ç¡®è®¤å¯æ¥å—çš„ç®€åŒ–æ–¹æ¡ˆ",
            "ç”¨æ²Ÿé€šæ¢æ—¶é—´ä¸æˆæœ¬ã€‚",
            { delayDaysDelta: 1, marginPctDelta: -0.2, satisfactionDelta: -2 },
            { negotiation: +2, project_planning: +1 },
            {}
          ),
          createChoice(
            "SHIP_C",
            "æŒ‰å½“å‰åšæ³•å‘èµ°ï¼ˆä¸æ”¹ï¼‰",
            "çŸ­æœŸå¿«ï¼Œä½†åç»­è¡¥èµ„æ–™æˆ–è¢«å®¢æˆ·æŒ‘åˆºé£é™©ä¸Šå‡ã€‚",
            { delayDaysDelta: 0, qualityRiskDelta: +6, satisfactionDelta: -4 },
            { risk_judgement: -2 },
            {}
          )
        ]
      ),
      () => createIssue(
        "SHIP_RELEASE_DELAY_" + Math.random().toString(36).slice(2,6),
        "shipment_ready",
        "å†…éƒ¨æ”¾è¡Œ/å‡ºåº“æµç¨‹å»¶è¯¯",
        "å‘è´§å‰éœ€è¦è·¨éƒ¨é—¨ç¡®è®¤ï¼ˆè´¨æ£€/ä»“åº“/å•è¯ï¼‰ï¼Œä½†å†…éƒ¨æ²Ÿé€šä¸é¡ºå¯¼è‡´æ”¾è¡Œå»¶è¿Ÿã€‚",
        pickOne(["L","M"]),
        [
          createChoice(
            "SHIP2_A",
            "ä¸»åŠ¨åè°ƒï¼Œæ‹‰ç¾¤å¿«é€Ÿå¯¹é½æ”¾è¡Œæ¡ä»¶",
            "æé«˜æ•ˆç‡ï¼Œä½†éœ€è¦æŠ•å…¥æ²Ÿé€šæˆæœ¬ã€‚",
            { delayDaysDelta: 2, internalFrictionDelta: +6 },
            { project_planning: +3, risk_judgement: +1 },
            {}
          ),
          createChoice(
            "SHIP2_B",
            "èµ°æ­£å¼æµç¨‹æŒ‰ç« æ¨è¿›",
            "æ›´åˆè§„ï¼Œä½†å¯èƒ½æ›´æ…¢ã€‚",
            { delayDaysDelta: 4 },
            { risk_judgement: +2, project_planning: +1 },
            {}
          ),
          createChoice(
            "SHIP2_C",
            "å…ˆå‘éƒ¨åˆ†è´§ï¼ˆåˆ†æ‰¹å‡ºåº“ï¼‰",
            "ç¼“è§£äº¤æœŸå‹åŠ›ï¼Œä½†å•è¯ä¸è¿è¾“å¤æ‚åº¦ä¸Šå‡ã€‚",
            { delayDaysDelta: 1, marginPctDelta: -0.8, internalFrictionDelta: +4 },
            { project_planning: +2, cash_flow: +1 },
            {}
          )
        ]
      )
    ];
    return pickOne(pool)();
  }

  if (stageKey === "transport"){
    const pool = [
      () => createIssue(
        "TRANS_FORWARDER_PROBLEM_" + Math.random().toString(36).slice(2,6),
        "transport",
        "è´§ä»£åé¦ˆèˆ±ä½/è·¯çº¿ä¸ç¨³å®š",
        "è´§ä»£é€šçŸ¥ï¼šèˆ±ä½ç´§å¼ æˆ–èˆªçº¿è°ƒæ•´ï¼Œå¯èƒ½å½±å“é¢„è®¡åˆ°æ¸¯æ—¶é—´ã€‚ä½ ä»¬å®é™…æ›´å¸¸é‡åˆ°â€œè´§ä»£/æŠ¥å…³é—®é¢˜â€è€Œéâ€œæ¸¯å£å µå¡â€ã€‚",
        pickOne(["L","M"]),
        [
          createChoice(
            "TRANS_A",
            "æ¢è´§ä»£/æ¢è·¯çº¿ï¼ˆæé«˜ç¡®å®šæ€§ï¼‰",
            "æˆæœ¬ä¸Šå‡ï¼Œä½†äº¤æœŸæ›´å¯æ§ã€‚",
            { delayDaysDelta: 1, marginPctDelta: -1.2, qualityRiskDelta: 0 },
            { supplier_control: +2, project_planning: +2, risk_judgement: +1 },
            {}
          ),
          createChoice(
            "TRANS_B",
            "åšæŒåŸæ–¹æ¡ˆç­‰å¾…ï¼ˆä½æˆæœ¬ï¼‰",
            "æˆæœ¬ä½ï¼Œä½†äº¤æœŸä¸ç¡®å®šï¼Œå®¢æˆ·æ»¡æ„åº¦å¯èƒ½ä¸‹é™ã€‚",
            { delayDaysDelta: 7, satisfactionDelta: -6 },
            { risk_judgement: +1, cash_flow: +1 },
            {}
          ),
          createChoice(
            "TRANS_C",
            "ç©ºè¿/å¿«è¿éƒ¨åˆ†å…³é”®ä»¶ï¼ˆè¡¥æ•‘ï¼‰",
            "è´¹ç”¨é«˜ï¼Œä½†èƒ½æ§åˆ¶å…³é”®èŠ‚ç‚¹ã€‚",
            { delayDaysDelta: -5, marginPctDelta: -3, cashRiskDelta: +8 },
            { project_planning: +2, cash_flow: -2, risk_judgement: +1 },
            {}
          )
        ]
      )
    ];
    return pickOne(pool)();
  }

  if (stageKey === "customs"){
    const pool = [
      () => createIssue(
        "CUS_DOC_MISMATCH_" + Math.random().toString(36).slice(2,6),
        "customs",
        "æŠ¥å…³èµ„æ–™ä¸å®é™…ä¿¡æ¯ä¸å®Œå…¨ä¸€è‡´",
        "å•è¯å¤æ ¸å‘ç°ï¼šå“åã€HSã€æè´¨æè¿°ã€é‡é‡/ä»¶æ•°æˆ–é™„ä»¶æ¸…å•å­˜åœ¨ä¸ä¸€è‡´ã€‚è‹¥ä¸å¤„ç†ï¼Œå¯èƒ½è¢«è¦æ±‚è¡¥èµ„æ–™æˆ–é€€å•é‡æŠ¥ã€‚",
        pickOne(["M","H"]),
        [
          createChoice(
            "CUS_A",
            "ç«‹å³è¡¥é½èµ„æ–™å¹¶ä¿®æ­£ç”³æŠ¥ï¼ˆåˆè§„ä¼˜å…ˆï¼‰",
            "äº¤æœŸç•¥å—å½±å“ï¼Œä½†é™ä½åç»­é£é™©ã€‚",
            { delayDaysDelta: 3, qualityRiskDelta: -1 },
            { risk_judgement: +4, project_planning: +2 },
            {}
          ),
          createChoice(
            "CUS_B",
            "ä¸æŠ¥å…³è¡Œåå•†æœ€å°æ”¹åŠ¨æ–¹æ¡ˆï¼ˆæŠ¢æ—¶é—´ï¼‰",
            "å¯èƒ½æ›´å¿«ï¼Œä½†å­˜åœ¨åˆè§„é£é™©ã€‚",
            { delayDaysDelta: 1, qualityRiskDelta: +2, cashRiskDelta: +2 },
            { negotiation: +2, risk_judgement: -2 },
            {}
          ),
          createChoice(
            "CUS_C",
            "æŒ‰åŸèµ„æ–™æäº¤ï¼ˆèµŒä¸ä¼šæŠ½æŸ¥ï¼‰",
            "çŸ­æœŸå¿«ï¼Œä½†ä¸€æ—¦è¢«å¡ä¼šæ›´æ…¢æ›´ç—›ã€‚",
            { delayDaysDelta: 0, qualityRiskDelta: +6, satisfactionDelta: -4 },
            { risk_judgement: -4 },
            {}
          )
        ]
      )
    ];
    return pickOne(pool)();
  }

  if (stageKey === "after_sales"){
    const pool = [
      () => createIssue(
        "AS_PERFORMANCE_GAP_" + Math.random().toString(36).slice(2,6),
        "after_sales",
        "å®¢æˆ·åé¦ˆæ€§èƒ½ä¸é¢„æœŸæœ‰å·®å¼‚ï¼ˆå¯é€‰å”®åï¼‰",
        "å®¢æˆ·åé¦ˆï¼šè¿è¡Œæ•ˆæœä¸é¢„æœŸæœ‰å·®å¼‚ï¼ˆä¸ä¸€å®šæ˜¯ä½ ä»¬äº§å“é—®é¢˜ï¼Œä¹Ÿå¯èƒ½æ˜¯å·¥å†µ/å®‰è£…/ç³»ç»Ÿè®¾è®¡ï¼‰ã€‚å¤„ç†æ–¹å¼ä¼šå½±å“é•¿æœŸå…³ç³»ã€‚",
        pickOne(["L","M"]),
        [
          createChoice(
            "AS_A",
            "æä¾›æŠ€æœ¯è§£é‡Š + æ•°æ®æ”¯æŒï¼ˆå·¥ç¨‹åŒ–å“åº”ï¼‰",
            "ç”¨æ•°æ®ã€å·¥å†µåˆ†æã€å¯¹æ ‡æ–¹æ¡ˆæ”¯æŒå®¢æˆ·ã€‚",
            { satisfactionDelta: +8, qualityRiskDelta: -2, marginPctDelta: -0.2 },
            { quality_bottom_line: +2, risk_judgement: +2, negotiation: +1 },
            {}
          ),
          createChoice(
            "AS_B",
            "æä¾›æœ‰é™è¡¥å¿/å¤‡ä»¶ï¼ˆå¿«é€Ÿå¹³æ¯ï¼‰",
            "çŸ­æœŸæ•ˆæœå¥½ï¼Œä½†æˆæœ¬ä¸â€œå…ˆä¾‹é£é™©â€ä¸Šå‡ã€‚",
            { satisfactionDelta: +10, marginPctDelta: -1.5, cashRiskDelta: +2 },
            { negotiation: +2, cash_flow: -1, risk_judgement: -1 },
            {}
          ),
          createChoice(
            "AS_C",
            "å†·å¤„ç†ï¼ˆé£é™©ï¼‰",
            "çŸ­æœŸçœäº‹ï¼Œä½†å¯èƒ½ä¼¤å®³å£ç¢‘ä¸å¤è´­ã€‚",
            { satisfactionDelta: -12, qualityRiskDelta: +6 },
            { risk_judgement: -3 },
            {}
          )
        ]
      )
    ];
    return pickOne(pool)();
  }

  return createIssue(
    "GENERIC_SMOOTH_" + stageKey + "_" + Math.random().toString(36).slice(2,6),
    stageKey,
    "æµç¨‹é¡ºåˆ©æ¨è¿›",
    "æœ¬é˜¶æ®µæœªå‘ç”Ÿæ˜æ˜¾å¼‚å¸¸ï¼ŒæŒ‰è®¡åˆ’æ¨è¿›ã€‚",
    "L",
    [],
    "smooth"
  );
}

function buildFollowupIssueByKey(followupKey, mailContext){
  if (followupKey === "PROC_CASH_TIGHT_POSSIBLE"){
    const trigger = Math.random() < 0.55;
    if (!trigger) return null;

    return createIssue(
      "PROC_CASH_TIGHT_" + Math.random().toString(36).slice(2,6),
      "procurement",
      "ç°é‡‘æµç´§å¼ ï¼Œé‡‡è´­ä»˜æ¬¾å—é˜»",
      "ä½ å·²å†³å®šé‡‡è´­ï¼Œä½†è´¢åŠ¡åé¦ˆï¼šå½“å‰ç°é‡‘å‘¨è½¬ç´§å¼ ï¼Œå¯èƒ½å½±å“ä¾›åº”å•†ä»˜æ¬¾ä¸äº¤æœŸã€‚éœ€è¦åšå†³ç­–ä»¥ä¿è¯é‡‡è´­è½åœ°ã€‚",
      pickOne(["M","H"]),
      [
        createChoice(
          "PROC_CASH_A",
          "ç”³è¯·å†…éƒ¨åè°ƒå«èµ„/åŠ æ€¥ä»˜æ¬¾ï¼ˆä¿è¯é‡‡è´­è½åœ°ï¼‰",
          "äº¤ä»˜æ›´ç¨³ï¼Œä½†ä¼šå¢åŠ å†…éƒ¨æ‘©æ“¦ä¸â€œè¢«ç›¯â€é£é™©ã€‚",
          { delayDaysDelta: 0, internalFrictionDelta: +10, cashRiskDelta: -4, marginPctDelta: -0.5 },
          { cash_flow: +4, risk_judgement: +2, project_planning: +1 },
          {}
        ),
        createChoice(
          "PROC_CASH_B",
          "æ‹†æ‰¹ä»˜æ¬¾/æ‹†æ‰¹é‡‡è´­ï¼ˆå…ˆå…³é”®ä»¶ï¼‰",
          "ç¼“è§£ç°é‡‘å‹åŠ›ï¼Œä½†ç®¡ç†å¤æ‚åº¦æå‡ã€‚",
          { delayDaysDelta: 3, internalFrictionDelta: +6, cashRiskDelta: -2 },
          { cash_flow: +3, project_planning: +2, risk_judgement: +1 },
          {}
        ),
        createChoice(
          "PROC_CASH_C",
          "å»¶åé‡‡è´­ç­‰å¾…å›æ¬¾ï¼ˆé£é™©ï¼‰",
          "ç°é‡‘å‹åŠ›ä¸‹é™ï¼Œä½†è®¢å•äº¤æœŸå—å½±å“ï¼Œå®¢æˆ·æ»¡æ„åº¦ä¸‹æ»‘ã€‚",
          { delayDaysDelta: 10, satisfactionDelta: -8, cashRiskDelta: -6 },
          { cash_flow: +1, risk_judgement: -1, project_planning: -2 },
          {}
        )
      ]
    );
  }
  return null;
}

/* -----------------------------
   4) Session & Order Model
------------------------------ */

function createNewSession(){
  return {
    year: 1,
    week: 1,
    maxWeeks: MAX_WEEKS,
    actionsLeft: ACTIONS_PER_WEEK,
    actionsPerWeek: ACTIONS_PER_WEEK,
    active: true,
    weekEndingLock: false,

    resources: {
      cashUSD: 1200000,
      receivablesUSD: 0
    },

    scores: createEmptyScores(),

    inboxMails: [],
    orders: {
      activeOrdersById: {},
      completedOrders: [],
      lostOrders: []
    },

    uiState: {
      view: "inbox",
      activeOrderId: null
    }
  };
}

function createOrderFromMail(mail){
  const baseRevenue = weightedPick([
    { value: randomInt(60000, 120000), weight: 35 },
    { value: randomInt(120000, 250000), weight: 35 },
    { value: randomInt(250000, 600000), weight: 20 },
    { value: randomInt(600000, 1200000), weight: 10 }
  ]);

  let baseMargin = randomFloat(14, 26);
  if (mail.type === "high_quality") baseMargin = randomFloat(18, 30);
  if (mail.type === "risky") baseMargin = randomFloat(10, 22);
  if (mail.type === "low_quality") baseMargin = randomFloat(12, 24);

  let baseWinChance = 62;
  if (mail.type === "high_quality") baseWinChance = 72;
  if (mail.type === "standard") baseWinChance = 60;
  if (mail.type === "risky") baseWinChance = 52;
  if (mail.type === "low_quality") baseWinChance = 48;

  const orderId = mail.id;

  return {
    id: orderId,
    mailContext: deepCopy(mail),
    status: "active",
    stageIndex: 0,
    stageKey: STAGES[0].key,
    stageIssues: [],
    currentIssueIndex: 0,

    vars: {
      revenueUSD: baseRevenue,
      marginPct: baseMargin,
      delayDays: 0,
      qualityRisk: 8,
      cashRisk: 10,
      customerSatisfaction: 72,
      internalFriction: 5,
      winChance: baseWinChance,
      lostChance: 10
    },

    createdWeek: null,
    completedWeek: null,
    logs: []
  };
}

function getStageByKey(stageKey){
  return STAGES.find(s => s.key === stageKey);
}

/* -----------------------------
   5) Engine
------------------------------ */

let session = createNewSession();

const engine = {
  init: function(){
    session = createNewSession();
    session.inboxMails = generateInboxForWeek(session.week);

    ui.log("ç³»ç»Ÿ", "è¿›å…¥ç¬¬ 1 å‘¨ã€‚æ”¶åˆ° " + session.inboxMails.length + " å°æ–°é‚®ä»¶ã€‚", "stage-good");
    ui.updateHeader();
    ui.updateSidebar();
    ui.renderInbox();
  },

  hardReset: function(){
    if (confirm("ç¡®å®šè¦é‡ç½®å—ï¼Ÿè¿™ä¼šæ¸…ç©ºå½“å‰è¿›åº¦ã€‚")){
      localStorage.removeItem("trade_quest_v5.0_save");
      this.init();
    }
  },

  quickSaveToLocal: function(){
    try{
      localStorage.setItem("trade_quest_v5.0_save", JSON.stringify(session));
      ui.toastModal("âœ… å·²ä¿å­˜", "å·²ä¿å­˜åˆ°æœ¬åœ°æµè§ˆå™¨ localStorageï¼ˆtrade_quest_v5.0_saveï¼‰ã€‚ä½ å¯ä»¥éšæ—¶ç‚¹å‡»â€œè¯»å–â€ã€‚");
    }catch(e){
      ui.toastModal("âŒ ä¿å­˜å¤±è´¥", "æµè§ˆå™¨å­˜å‚¨å¤±è´¥ï¼Œå¯èƒ½æ˜¯ç©ºé—´ä¸è¶³æˆ–è¢«ç¦ç”¨ã€‚");
    }
  },

  quickLoadFromLocal: function(){
    try{
      const raw = localStorage.getItem("trade_quest_v5.0_save");
      if (!raw){
        ui.toastModal("æç¤º", "æœªæ‰¾åˆ°æœ¬åœ°ä¿å­˜è®°å½•ã€‚");
        return;
      }
      const loaded = JSON.parse(raw);
      session = loaded;

      session.maxWeeks = session.maxWeeks || MAX_WEEKS;
      session.actionsPerWeek = session.actionsPerWeek || ACTIONS_PER_WEEK;
      if (typeof session.weekEndingLock !== "boolean") session.weekEndingLock = false;
      if (!session.uiState) session.uiState = { view: "inbox", activeOrderId: null };
      if (!session.orders) session.orders = { activeOrdersById:{}, completedOrders:[], lostOrders:[] };
      if (!session.scores) session.scores = createEmptyScores();
      if (!session.resources) session.resources = { cashUSD: 1200000, receivablesUSD: 0 };

      ui.log("ç³»ç»Ÿ", "å·²è¯»å–æœ¬åœ°å­˜æ¡£ã€‚", "stage-good");
      ui.updateHeader();
      ui.updateSidebar();

      if (session.uiState.view === "order" && session.uiState.activeOrderId){
        ui.renderOrder(session.uiState.activeOrderId);
      }else if (session.uiState.view === "year_end"){
        ui.renderYearEnd();
      }else{
        ui.renderInbox();
      }
    }catch(e){
      ui.toastModal("âŒ è¯»å–å¤±è´¥", "å­˜æ¡£è§£æå¤±è´¥ï¼Œå¯èƒ½å­˜æ¡£æŸåã€‚å»ºè®®é‡ç½®åé‡è¯•ã€‚");
    }
  },

  canUseAction: function(){
    return session.active && session.actionsLeft > 0;
  },

  consumeAction: function(reason){
    if (!session.active) return false;

    if (session.actionsLeft <= 0){
      ui.showWeekEndModal();
      return false;
    }

    session.actionsLeft = session.actionsLeft - 1;
    ui.log("è¡ŒåŠ¨", "æ¶ˆè€— 1 æ¬¡è¡ŒåŠ¨ï¼š" + reason, null);
    ui.updateHeader();
    ui.updateSidebar();

    if (session.actionsLeft === 0){
      ui.showWeekEndModal();
    }
    return true;
  },

  // âœ… ä¿®å¤ï¼šç¬¬24å‘¨ç»“æŸç›´æ¥ç»“ç®—ï¼Œä¸è¿›å…¥25å‘¨
  endWeek: function(){
    if (!session.active) return;
    if (session.weekEndingLock) return;
    session.weekEndingLock = true;

    const collected = session.resources.receivablesUSD * 0.18;
    session.resources.cashUSD += collected;
    session.resources.receivablesUSD -= collected;

    if (session.week >= session.maxWeeks){
      session.active = false;
      session.uiState.view = "year_end";
      session.uiState.activeOrderId = null;

      ui.log("ç³»ç»Ÿ", `ğŸ“Œ ç¬¬ ${session.week} å‘¨ç»“æŸã€‚è¿›å…¥å¹´åº¦ç»“ç®—ã€‚å›æ”¶ç°é‡‘ï¼š${formatMoneyUSD(collected)}`, "stage-good");
      ui.updateHeader();
      ui.updateSidebar();
      ui.renderYearEnd();

      setTimeout(() => { session.weekEndingLock = false; }, 300);
      return;
    }

    session.week = session.week + 1;
    session.actionsLeft = session.actionsPerWeek;

    session.inboxMails = generateInboxForWeek(session.week);

    ui.log("ç³»ç»Ÿ", "è¿›å…¥ç¬¬ " + session.week + " å‘¨ã€‚æ”¶åˆ° " + session.inboxMails.length + " å°æ–°é‚®ä»¶ã€‚å›æ”¶ç°é‡‘ï¼š" + formatMoneyUSD(collected), "stage-good");

    ui.updateHeader();
    ui.updateSidebar();

    if (session.uiState.view === "order" && session.uiState.activeOrderId){
      ui.renderOrder(session.uiState.activeOrderId);
    }else{
      session.uiState.view = "inbox";
      ui.renderInbox();
    }

    setTimeout(() => { session.weekEndingLock = false; }, 300);
  },

  openMailAsOrder: function(mailId){
    const mail = (session.inboxMails || []).find(m => m.id === mailId);
    if (!mail){
      ui.toastModal("æ‰“å¼€å¤±è´¥", "è¯¥é‚®ä»¶ä¸åœ¨å½“å‰æ”¶ä»¶ç®±ï¼ˆå¯èƒ½å·²è¢«åˆ·æ–°æˆ–å·²å¤„ç†ï¼‰ã€‚");
      return;
    }

    if (session.orders.activeOrdersById && session.orders.activeOrdersById[mailId]){
      session.uiState.view = "order";
      session.uiState.activeOrderId = mailId;
      ui.log("ç³»ç»Ÿ", "åˆ‡æ¢åˆ°è®¢å•ï¼š" + mail.customer + " â€” " + mail.subject, "stage-good");
      ui.updateSidebar();
      ui.renderOrder(mailId);
      return;
    }

    const order = createOrderFromMail(mail);
    order.createdWeek = session.week;

    session.inboxMails = session.inboxMails.filter(m => m.id !== mailId);
    session.orders.activeOrdersById[order.id] = order;

    this.enterStage(order.id, STAGES[0].key);

    session.uiState.view = "order";
    session.uiState.activeOrderId = order.id;

    ui.log("ç³»ç»Ÿ", "æ‰“å¼€è¯¢å•å¹¶åˆ›å»ºè®¢å•ï¼š" + mail.customer + " â€” " + mail.subject, "stage-good");
    ui.updateHeader();
    ui.updateSidebar();
    ui.renderOrder(order.id);
  },

  enterStage: function(orderId, stageKey){
    const order = session.orders.activeOrdersById[orderId];
    if (!order) return;

    order.stageKey = stageKey;
    order.stageIndex = STAGES.findIndex(s => s.key === stageKey);
    order.stageIssues = [];
    order.currentIssueIndex = 0;

    // completion èŠ‚ç‚¹ï¼šç›´æ¥å®Œæˆ
    if (stageKey === "completion"){
      this.archiveOrder(orderId, "completed", "è®¢å•é¡ºåˆ©å®Œæˆ");
      return;
    }

    // after_salesï¼šæŒ‰æ¦‚ç‡å‡ºç°ï¼Œä¹Ÿå¯èƒ½ç›´æ¥ç»“æŸ
    if (stageKey === "after_sales"){
      const go = Math.random() < 0.55;
      if (!go){
        this.archiveOrder(orderId, "completed", "è®¢å•å®Œæˆï¼ˆæ— å”®åè§¦å‘ï¼‰");
        return;
      }
      const issueCount = rollIssueCountForStage(stageKey);
      if (issueCount === 0){
        order.stageIssues.push(createIssue(
          "SMOOTH_" + stageKey + "_" + Math.random().toString(36).slice(2,6),
          stageKey,
          "æµç¨‹é¡ºåˆ©æ¨è¿›",
          "æœ¬é˜¶æ®µæœªå‘ç”Ÿæ˜æ˜¾å¼‚å¸¸ï¼ŒæŒ‰è®¡åˆ’æ¨è¿›ï¼ˆæ— éœ€æ¶ˆè€—è¡ŒåŠ¨ç‚¹ï¼‰ã€‚",
          "L",
          [],
          "smooth"
        ));
        return;
      }
      for (let i = 0; i < issueCount; i++){
        order.stageIssues.push(buildIssueForStage(stageKey, order.mailContext));
      }
      return;
    }

    const issueCount = rollIssueCountForStage(stageKey);

    if (issueCount === 0){
      order.stageIssues.push(
        createIssue(
          "SMOOTH_" + stageKey + "_" + Math.random().toString(36).slice(2,6),
          stageKey,
          "æµç¨‹é¡ºåˆ©æ¨è¿›",
          "æœ¬é˜¶æ®µæœªå‘ç”Ÿæ˜æ˜¾å¼‚å¸¸ï¼ŒæŒ‰è®¡åˆ’æ¨è¿›ï¼ˆæ— éœ€æ¶ˆè€—è¡ŒåŠ¨ç‚¹ï¼‰ã€‚",
          "L",
          [],
          "smooth"
        )
      );
      return;
    }

    for (let i = 0; i < issueCount; i++){
      const issue = buildIssueForStage(stageKey, order.mailContext);
      order.stageIssues.push(issue);
    }
  },

  getCurrentIssue: function(orderId){
    const order = session.orders.activeOrdersById[orderId];
    if (!order) return null;
    if (!order.stageIssues || order.stageIssues.length === 0) return null;
    return order.stageIssues[order.currentIssueIndex] || null;
  },

  resolveSmoothAndAdvance: function(orderId){
    const order = session.orders.activeOrdersById[orderId];
    if (!order) return;

    ui.log("ç³»ç»Ÿ", "é˜¶æ®µé¡ºåˆ©æ¨è¿›ï¼š" + getStageByKey(order.stageKey).name, "stage-good");
    this.advanceToNextStageOrFinish(orderId);
    ui.updateSidebar();
    if (session.orders.activeOrdersById[orderId]) ui.renderOrder(orderId);
  },

  chooseResponse: function(orderId, issueId, choiceId){
    const order = session.orders.activeOrdersById[orderId];
    if (!order) return;

    const issue = this.getCurrentIssue(orderId);
    if (!issue || issue.id !== issueId){
      ui.toastModal("æç¤º", "å½“å‰é—®é¢˜å·²å˜åŒ–æˆ–ä¸å­˜åœ¨ï¼Œè¯·åˆ·æ–°é¡µé¢è§†å›¾ã€‚");
      ui.renderOrder(orderId);
      return;
    }

    const ok = this.consumeAction("åº”å¯¹å†³ç­–");
    if (!ok) return;

    const choice = (issue.choices || []).find(c => c.id === choiceId);
    if (!choice){
      ui.toastModal("æç¤º", "é€‰é¡¹ä¸å­˜åœ¨ã€‚");
      return;
    }

    // snapshot before
    const beforeOrder = deepCopy(order.vars);
    const beforeRes = deepCopy(session.resources);
    const beforeScores = deepCopy(session.scores);

    // apply
    applyEffects(session, order, choice.effects);
    applyScoreDelta(session, choice.scoreDelta);

    // deltas (AFTER - BEFORE)
    const afterOrder = order.vars;
    const afterRes = session.resources;
    const deltas = {
      marginPct: afterOrder.marginPct - beforeOrder.marginPct,
      delayDays: afterOrder.delayDays - beforeOrder.delayDays,
      qualityRisk: afterOrder.qualityRisk - beforeOrder.qualityRisk,
      cashRisk: afterOrder.cashRisk - beforeOrder.cashRisk,
      satisfaction: afterOrder.customerSatisfaction - beforeOrder.customerSatisfaction,
      internalFriction: afterOrder.internalFriction - beforeOrder.internalFriction,
      winChance: afterOrder.winChance - beforeOrder.winChance,
      lostChance: afterOrder.lostChance - beforeOrder.lostChance,
      cashUSD: afterRes.cashUSD - beforeRes.cashUSD,
      receivablesUSD: afterRes.receivablesUSD - beforeRes.receivablesUSD
    };

    const scoreDeltas = {};
    for (const k of CAPABILITY_KEYS){
      scoreDeltas[k] = (session.scores[k] || 0) - (beforeScores[k] || 0);
    }

    const stageName = getStageByKey(order.stageKey).name;
    ui.log("å†³ç­–", "ã€" + stageName + "ã€‘" + issue.title + " â†’ é€‰æ‹©ï¼š" + choice.title, "stage-risk");
    order.logs.push({
      week: session.week,
      stageKey: order.stageKey,
      issueId: issue.id,
      choiceId: choice.id,
      text: issue.title + " / " + choice.title
    });

    // show result modal
    ui.showChoiceResultModal(stageName, issue, choice, deltas, scoreDeltas);

    if (choice.result === "lost"){
      this.archiveOrder(orderId, "lost", "è¯¢å•/è®¢å•è‡ªç„¶æµå¤±");
      return;
    }

    if (choice.followups && choice.followups.length > 0){
      for (const followKey of choice.followups){
        const followIssue = buildFollowupIssueByKey(followKey, order.mailContext);
        if (followIssue){
          order.stageIssues.splice(order.currentIssueIndex + 1, 0, followIssue);
        }
      }
    }

    order.currentIssueIndex = order.currentIssueIndex + 1;

    if (order.currentIssueIndex >= order.stageIssues.length){
      ui.log("ç³»ç»Ÿ", "æœ¬é˜¶æ®µé—®é¢˜å¤„ç†å®Œæ¯•ï¼š" + stageName, "stage-good");
      this.advanceToNextStageOrFinish(orderId);
    }

    ui.updateHeader();
    ui.updateSidebar();
    if (session.orders.activeOrdersById[orderId]) ui.renderOrder(orderId);
  },

  advanceToNextStageOrFinish: function(orderId){
    const order = session.orders.activeOrdersById[orderId];
    if (!order) return;

    const stageKey = order.stageKey;

    // inquiry: å¯èƒ½è‡ªç„¶æµå¤±
    if (stageKey === "inquiry"){
      const loseRoll = Math.random() * 100;
      const loseChance = clampNumber(order.vars.lostChance, 0, 75);
      if (loseRoll < loseChance){
        this.archiveOrder(orderId, "lost", "è¯¢å•æœªæ¨è¿›åˆ°ä¸‹å•é˜¶æ®µï¼ˆè‡ªç„¶æµå¤±ï¼‰");
        return;
      }
      this.enterStage(orderId, "pre_order");
      return;
    }

    // pre_order: å¯èƒ½è°ˆåˆ¤å¤±è´¥
    if (stageKey === "pre_order"){
      const roll = Math.random() * 100;
      const winChance = clampNumber(order.vars.winChance, 10, 95);
      if (roll > winChance){
        this.archiveOrder(orderId, "lost", "åˆåŒé˜¶æ®µæœªèƒ½è¾¾æˆï¼ˆè°ˆåˆ¤å¤±è´¥ï¼‰");
        return;
      }
      this.enterStage(orderId, "procurement");
      return;
    }

    // stage transition
    const idx = STAGES.findIndex(s => s.key === stageKey);
    if (idx >= 0 && idx < STAGES.length - 1){
      const nextStage = STAGES[idx + 1].key;

      // completion -> after_sales (å¯é€‰) or done
      if (nextStage === "completion"){
        // å…ˆåˆ° completionï¼ŒenterStage å†…ä¼š archive completed
        this.enterStage(orderId, "completion");
        return;
      }

      // after completion, we won't reach here because completion archived.
      this.enterStage(orderId, nextStage);
      return;
    }

    this.archiveOrder(orderId, "completed", "è®¢å•é¡ºåˆ©å®Œæˆ");
  },

  archiveOrder: function(orderId, status, reason){
    const order = session.orders.activeOrdersById[orderId];
    if (!order) return;

    delete session.orders.activeOrdersById[orderId];

    order.status = status;
    order.completedWeek = session.week;

    if (status === "completed"){
      session.orders.completedOrders.push(order);
      const profit = order.vars.revenueUSD * order.vars.marginPct / 100;
      session.resources.cashUSD += profit;
      ui.log("å®Œæˆ", "è®¢å•å®Œæˆï¼š" + order.mailContext.customer + "ï¼ˆåˆ©æ¶¦ " + formatMoneyUSD(profit) + "ï¼‰", "stage-good");
    }else{
      session.orders.lostOrders.push(order);
      ui.log("æµå¤±", "è®¢å•æµå¤±ï¼š" + order.mailContext.customer + "ï¼ˆ" + reason + "ï¼‰", "stage-risk");
    }

    session.uiState.view = "inbox";
    session.uiState.activeOrderId = null;

    ui.updateHeader();
    ui.updateSidebar();
    ui.renderInbox();
  }
};

/* -----------------------------
   6) UI
------------------------------ */

const ui = {
    toggleSidebar(){
  const aside = document.querySelector("aside");
  if (!aside) return;
  aside.classList.toggle("mobile-open");
},

  updateHeader(){
    document.getElementById("disp-year").textContent = session.year;
    document.getElementById("disp-week").textContent = session.week;
    document.getElementById("disp-maxweek").textContent = session.maxWeeks;
    document.getElementById("disp-actions").textContent = session.actionsLeft + "/" + session.actionsPerWeek;
  },

  updateSidebar(){
    const ord = session.orders.activeOrdersById[session.uiState.activeOrderId];
    

    // pill
    const pill = document.getElementById("ord-pill");
    if (!ord){
      pill.textContent = "â€”";
      pill.className = "pill";
    }else{
      pill.textContent = ord.status === "active" ? "Active" : ord.status;
      pill.className = "pill " + (ord.vars.qualityRisk >= 70 ? "H" : (ord.vars.qualityRisk >= 35 ? "M" : "L"));
    }

    document.getElementById("ord-id").textContent = ord ? ord.id : "--";
    document.getElementById("ord-stage").textContent = ord ? getStageByKey(ord.stageKey).name : "--";
    document.getElementById("ord-rev").textContent = ord ? formatMoneyUSD(ord.vars.revenueUSD) : "--";
    document.getElementById("ord-margin").textContent = ord ? formatPercent(ord.vars.marginPct) : "--";
    document.getElementById("ord-delay").textContent = ord ? ord.vars.delayDays + "d" : "0d";
    document.getElementById("ord-risk").textContent = ord ? ord.vars.qualityRisk : "0";
    document.getElementById("ord-sat").textContent = ord ? ord.vars.customerSatisfaction : "--";

    const radar = document.getElementById("score-radar");
    radar.innerHTML = "";
    for (const k of CAPABILITY_KEYS){
      const v = session.scores[k] || 0;
      const pct = clampNumber(50 + v * 5, 0, 100);
      radar.innerHTML += `
        <div class="cap-bar-container">
          <div class="cap-label">${CAPABILITY_LABELS_CN[k]}</div>
          <div class="cap-track">
            <div class="cap-fill ${v<0?"neg":""}" style="width:${pct}%"></div>
          </div>
        </div>`;
    }
  },

  log(who, text, cls){
    const el = document.getElementById("log-container");
    const div = document.createElement("div");
    div.className = "log-entry " + (cls||"");
    div.innerHTML = `<div class="log-time">${nowTimeTag(session.week)} Â· ${who}</div>${text}`;
    el.prepend(div);
  },

  toggleManual(){
    document.getElementById("manual-drawer").classList.toggle("open");
  },

  closeModal(){
    document.getElementById("modal-overlay").classList.remove("active");
  },

  toastModal(title, text){
    const box = document.getElementById("modal-overlay");
    const cont = document.getElementById("modal-content");
    cont.innerHTML = `
      <h3>${title}</h3>
      <p style="margin-top:8px" class="subtle">${text}</p>
      <div style="text-align:right;margin-top:14px">
        <button class="btn btn-primary" onclick="ui.closeModal()">ç¡®å®š</button>
      </div>`;
    box.classList.add("active");
  },

  showWeekEndModal(){
    const box = document.getElementById("modal-overlay");
    const cont = document.getElementById("modal-content");
    cont.innerHTML = `
      <h3>ğŸ“… æœ¬å‘¨ç»“æŸ</h3>
      <p style="margin-top:8px" class="subtle">è¡ŒåŠ¨ç‚¹å·²ç”¨å®Œï¼Œè¿›å…¥ä¸‹ä¸€å‘¨ã€‚</p>
      <div style="text-align:right;margin-top:14px">
        <button class="btn btn-primary" onclick="ui.closeModal();engine.endWeek();">è¿›å…¥ä¸‹ä¸€å‘¨</button>
      </div>`;
    box.classList.add("active");
  },

  showChoiceResultModal(stageName, issue, choice, deltas, scoreDeltas){
    const box = document.getElementById("modal-overlay");
    const cont = document.getElementById("modal-content");

    const moneyRow = (label, v) => `
      <div style="display:flex;justify-content:space-between;margin:4px 0;font-size:12px;color:var(--secondary);">
        <span>${label}</span><span class="${v<0?"bad":"good"}">${signed(v,0)} ${label.includes("ç°é‡‘")?"USD":""}</span>
      </div>
    `;

    cont.innerHTML = `
      <h3>ğŸ“Š å†³ç­–ç»“æœ â€” ${stageName}</h3>
      <p style="margin-top:6px" class="subtle">${issue.title} / <b>${choice.title}</b></p>

      <div class="summary-grid">
        <div class="summary-item">
          <div class="label">äº¤æœŸ</div>
          <div class="value ${deltas.delayDays>0?"bad":"good"}">${signed(deltas.delayDays)} d</div>
        </div>
        <div class="summary-item">
          <div class="label">æ¯›åˆ©ç‡</div>
          <div class="value ${deltas.marginPct<0?"bad":"good"}">${signed(deltas.marginPct,1)}%</div>
        </div>
        <div class="summary-item">
          <div class="label">è´¨é‡é£é™©</div>
          <div class="value ${deltas.qualityRisk>0?"bad":"good"}">${signed(deltas.qualityRisk)}</div>
        </div>
        <div class="summary-item">
          <div class="label">æ»¡æ„åº¦</div>
          <div class="value ${deltas.satisfaction<0?"bad":"good"}">${signed(deltas.satisfaction)}</div>
        </div>
      </div>

      <div style="background:#f8fafc;border:1px solid var(--border);border-radius:12px;padding:10px;">
        <div style="font-weight:900;margin-bottom:6px">è¡¥å……å½±å“</div>
        ${moneyRow("ç°é‡‘å˜åŒ–", deltas.cashUSD)}
        ${moneyRow("åº”æ”¶å˜åŒ–", deltas.receivablesUSD)}
        ${moneyRow("å›æ¬¾é£é™©", deltas.cashRisk)}
        ${moneyRow("å†…éƒ¨æ‘©æ“¦", deltas.internalFriction)}
        ${moneyRow("èµ¢å•æ¦‚ç‡", deltas.winChance)}
        ${moneyRow("ä¸¢å•æ¦‚ç‡", deltas.lostChance)}
      </div>

      <div style="text-align:right;margin-top:14px">
        <button class="btn btn-primary" onclick="ui.closeModal()">ç¡®è®¤</button>
      </div>
    `;
    box.classList.add("active");
  },

  // âœ… æ–°å¢ï¼šä¸»åŠ¨æ”¾å¼ƒå®¢æˆ·ï¼ˆå½’æ¡£ä¸ºä¸¢å•ï¼‰
  abandonOrder(orderId){
    const order = session.orders.activeOrdersById[orderId];
    if (!order) return;
    const ok = confirm("ç¡®å®šè¦æ”¾å¼ƒè¯¥å®¢æˆ·/è®¢å•å—ï¼Ÿè¿™ä¼šç›´æ¥åˆ¤å®šä¸ºä¸¢å•å¹¶å½’æ¡£ã€‚");
    if (!ok) return;
    engine.archiveOrder(orderId, "lost", "ä¸»åŠ¨æ”¾å¼ƒè¯¥å®¢æˆ·ï¼ˆèµ„æºèšç„¦ï¼‰");
  },

  // âœ… æ”¶ä»¶ç®±ï¼šåŒ…å«è¿›è¡Œä¸­è®¢å•åˆ—è¡¨ï¼ˆå¹¶è¡Œåˆ‡æ¢å…¥å£ï¼‰
  renderInbox(){
    session.uiState.view = "inbox";
    const main = document.getElementById("main-view");

    const activeOrders = Object.values(session.orders.activeOrdersById || {});
    const activeHtml = activeOrders.length === 0 ? `
      <div class="panel subtle">å½“å‰æ²¡æœ‰è¿›è¡Œä¸­çš„è®¢å•ã€‚</div>
    ` : `
      <div class="panel">
        <div class="section-title">è¿›è¡Œä¸­è®¢å•ï¼ˆç‚¹å‡»åˆ‡æ¢ï¼‰</div>
        <div class="inbox-list">
          ${activeOrders.map(o=>`
            <div class="mail-item" onclick="ui.renderOrder('${o.id}')">
              <div><span class="tag tag-standard">è¿›è¡Œä¸­</span></div>
              <div>
                <b>${o.mailContext.customer}</b><br/>
                <span class="subtle">${o.mailContext.subject}</span><br/>
                <small class="subtle">é˜¶æ®µï¼š${getStageByKey(o.stageKey).name} ï½œå»¶è¯¯ï¼š${o.vars.delayDays}d ï½œè´¨é‡é£é™©ï¼š${o.vars.qualityRisk} ï½œæ»¡æ„ï¼š${o.vars.customerSatisfaction}</small>
              </div>
            </div>
          `).join("")}
        </div>
      </div>
    `;

    main.innerHTML = `
      <h2>ğŸ“¥ æ”¶ä»¶ç®±</h2>
      ${activeHtml}
      <div style="height:12px"></div>
      <div class="panel">
        <div class="section-title">æ–°é‚®ä»¶ï¼ˆç‚¹å‡»åˆ›å»ºè®¢å•ï¼‰</div>
        <div class="inbox-list">
          ${session.inboxMails.map(m=>`
            <div class="mail-item" onclick="engine.openMailAsOrder('${m.id}')">
              <div><span class="tag ${m.tagClass}">${m.qualityLabel}</span></div>
              <div>
                <b>${m.customer}</b><br/>
                <span class="subtle">${m.subject}</span><br/>
                <small class="subtle">${m.snippet}</small>
              </div>
            </div>
          `).join("")}
        </div>
      </div>`;
  },

  // âœ… è®¢å•é¡µï¼šæ–°å¢è¿”å›æ”¶ä»¶ç®± + æ”¾å¼ƒæŒ‰é’®ï¼ˆä¸æ¶ˆè€—è¡ŒåŠ¨ç‚¹ï¼‰
  renderOrder(orderId){
    const order = session.orders.activeOrdersById[orderId];
    if (!order){ this.renderInbox(); return; }

    session.uiState.view = "order";
    session.uiState.activeOrderId = orderId;

    const issue = engine.getCurrentIssue(orderId);
    const main = document.getElementById("main-view");

    const topActions = `
      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:14px;">
        <button class="btn btn-outline" onclick="ui.renderInbox()">â¬… è¿”å›æ”¶ä»¶ç®±</button>
        <button class="btn btn-danger" onclick="ui.abandonOrder('${orderId}')">ğŸ§¨ æ”¾å¼ƒè¯¥å®¢æˆ·</button>
      </div>
    `;

    if (!issue || issue.systemTag === "smooth"){
      main.innerHTML = `
        ${topActions}
        <div class="muted-box">
          <p class="subtle">æœ¬é˜¶æ®µæ— å¼‚å¸¸ï¼Œè‡ªåŠ¨æ¨è¿›ï¼ˆä¸æ¶ˆè€—è¡ŒåŠ¨ç‚¹ï¼‰ã€‚</p>
          <div style="margin-top:12px;">
            <button class="btn btn-primary" onclick="engine.resolveSmoothAndAdvance('${orderId}')">ç»§ç»­</button>
          </div>
        </div>`;
      return;
    }

    main.innerHTML = `
      ${topActions}
      <div class="stage-header">
        <span class="stage-badge">${getStageByKey(order.stageKey).name}</span>
        <span class="pill ${issue.severity}">é£é™© ${issue.severity}</span>
      </div>

      <div class="issue-card">
        <div class="issue-title">${issue.title}</div>
        <div class="issue-desc">${issue.description}</div>

        <div class="choice-grid">
          ${issue.choices.map(c=>`
            <div class="choice-btn" onclick="engine.chooseResponse('${orderId}','${issue.id}','${c.id}')">
              <div class="choice-title">${c.title}</div>
              <div class="choice-meta">${c.explanation}</div>
            </div>
          `).join("")}
        </div>

        <div style="margin-top:12px;background:#f8fafc;border:1px solid var(--border);border-radius:12px;padding:10px;">
          <div class="subtle">
            æç¤ºï¼šæœ¬ç³»ç»Ÿä¸ä¼šåœ¨ç‚¹å‡»å‰æ˜¾ç¤ºä»»ä½•â€œæ•°å€¼åæœâ€ã€‚åªæœ‰ä½ åšå‡ºé€‰æ‹©åæ‰æ­ç¤ºç»“æœã€‚
          </div>
        </div>
      </div>`;
  },

  // âœ… å¹´åº¦ç»“ç®—é¡µï¼šèƒ½åŠ›ç”»åƒ + è¯„ä»· + å»ºè®® + æ¨èé˜…è¯»
  renderYearEnd(){
    session.uiState.view = "year_end";
    const main = document.getElementById("main-view");

    const completed = (session.orders.completedOrders || []).length;
    const lost = (session.orders.lostOrders || []).length;

    const rows = CAPABILITY_KEYS.map(k => ({ key:k, label: CAPABILITY_LABELS_CN[k], score:(session.scores[k]||0) }))
      .sort((a,b)=>b.score-a.score);

    const total = rows.reduce((s,r)=>s+r.score,0);

    function level(v){
      if (v >= 12) return "å¼ºé¡¹";
      if (v >= 5) return "åˆæ ¼";
      if (v >= -4) return "å¾…åŠ å¼º";
      return "é«˜é£é™©çŸ­æ¿";
    }

    const weak = rows.filter(r=>r.score<=0).slice(0,4).map(r=>r.label);
    const advice = [];
    if (weak.includes("çº¿ç´¢åˆ¤æ–­")){
      advice.push("çº¿ç´¢åˆ¤æ–­åå¼±ï¼šå»ºè®®å»ºç«‹â€œèµ„æ ¼ç¡®è®¤æ¸…å•â€ï¼ˆç»ˆç«¯/é¢„ç®—/æ—¶é—´/æŠ€æœ¯è¾¹ç•Œ/ä»˜æ¬¾ï¼‰ï¼Œå‡å°‘å¥—ä»·ä¸ä½è´¨è¯¢ç›˜æ¶ˆè€—ã€‚");
    }
    if (weak.includes("æŠ¥ä»·æˆæœ¬")){
      advice.push("æŠ¥ä»·æˆæœ¬åå¼±ï¼šå»ºè®®æŠŠæŠ¥ä»·æ‹†æˆ BOM/å·¥æ—¶/å¤–å/è¿è¾“/å•è¯/é£é™©æº¢ä»·ï¼Œå½¢æˆå¯å¤ç”¨æ¨¡æ¿ï¼Œé¿å…â€œå‡­æ„Ÿè§‰æŠ¥ä»·â€ã€‚");
    }
    if (weak.includes("å•†åŠ¡åšå¼ˆ")){
      advice.push("å•†åŠ¡åšå¼ˆåå¼±ï¼šå»ºè®®ç»ƒä¹ â€œè®©æ­¥æ¢æ¡ä»¶â€ï¼ˆäº¤æœŸ/ä»˜æ¬¾/è´¨ä¿/éªŒæ”¶/å¤‡ä»¶ï¼‰ï¼Œæ¯æ¬¡è®©æ­¥å¿…é¡»æ¢å›ä¸€ä¸ªæ›´ç¡®å®šçš„æ¡æ¬¾ã€‚");
    }
    if (weak.includes("èµ„é‡‘å›æ¬¾")){
      advice.push("èµ„é‡‘å›æ¬¾åå¼±ï¼šå»ºè®®æŠŠå›æ¬¾æ¡æ¬¾å‰ç½®åˆ°æŠ¥ä»·é˜¶æ®µï¼ˆé¢„ä»˜æ¬¾æ¯”ä¾‹ã€ä¿¡ç”¨è¯ã€é‡Œç¨‹ç¢‘ä»˜æ¬¾ï¼‰ï¼Œä¸è¦ç­‰åˆ°åˆåŒåå†äº‰ã€‚");
    }
    if (weak.includes("ä¾›åº”é“¾æ§")){
      advice.push("ä¾›åº”é“¾æ§åˆ¶åå¼±ï¼šå»ºè®®åšäºŒä¾›ç­–ç•¥å’Œå…³é”®ç‰©æ–™äº¤æœŸçœ‹æ¿ï¼Œå‡å°‘é‡‡è´­æ³¢åŠ¨å¯¹äº¤ä»˜çš„å†²å‡»ã€‚");
    }
    if (weak.includes("é¡¹ç›®è®¡åˆ’")){
      advice.push("é¡¹ç›®è®¡åˆ’åå¼±ï¼šå»ºè®®ç”¨â€œå…³é”®è·¯å¾„+ç¼“å†²â€ç®¡ç†äº¤æœŸï¼Œç”Ÿäº§/é‡‡è´­/å•è¯åˆ†åˆ«è®¾é‡Œç¨‹ç¢‘ã€‚");
    }
    if (weak.includes("è´¨é‡åº•çº¿")){
      advice.push("è´¨é‡åº•çº¿åå¼±ï¼šå»ºè®®å»ºç«‹â€œä¸å¯è®©æ­¥æ¸…å•â€ï¼ˆæ¥æ–™/å·¥è‰ºçª—å£/å‡ºå‚æ£€éªŒï¼‰ï¼Œä¸è¦ç”¨è´¨é‡èµŒäº¤æœŸã€‚");
    }
    if (weak.includes("é£é™©åˆ¤æ–­")){
      advice.push("é£é™©åˆ¤æ–­åå¼±ï¼šå»ºè®®åœ¨åˆåŒè¯„å®¡é˜¶æ®µæŠŠé£é™©æ˜¾æ€§åŒ–ï¼ˆè¿çº¦/éªŒæ”¶/è´¨ä¿/ä¸å¯æ§å› ç´ ï¼‰ï¼Œå¹¶é€šè¿‡ä»·æ ¼/æ¡æ¬¾å¯¹å†²ã€‚");
    }

    const verdict =
      total >= 35 ? "æˆæƒçº§ï¼šæ•´ä½“å†³ç­–ç¨³å®šï¼Œå…·å¤‡ç‹¬ç«‹æ¨è¿›é¡¹ç›®ä¸å®ˆä½åº•çº¿çš„èƒ½åŠ›ã€‚å»ºè®®ç»™æ›´é«˜æŠ¥ä»·æƒé™å¹¶è¦æ±‚æ²‰æ·€æ¨¡æ¿ã€‚" :
      total >= 15 ? "ç†Ÿç»ƒçº§ï¼šèƒ½æ¨è¿›è®¢å•ï¼Œä½†åœ¨æ¡æ¬¾/é£é™©/æˆæœ¬ä¸Šä»æœ‰æ³¢åŠ¨ã€‚å»ºè®®è®­ç»ƒåé€æ­¥æ”¾æƒï¼Œå¹¶è¦æ±‚å¤ç›˜ã€‚" :
      total >= 0 ? "ç»éªŒé©±åŠ¨ï¼šå®¹æ˜“åœ¨äº¤æœŸã€è´¨é‡æˆ–å›æ¬¾ä¸Šåšâ€œèµŒâ€ã€‚å»ºè®®å…ˆè¡¥é½æ–¹æ³•è®ºï¼Œå†æé€Ÿä¸æ”¾æƒã€‚" :
      "é«˜é£é™©ï¼šå­˜åœ¨ä½ä»·æŠ¢å•ã€è´¨é‡èµŒäº¤æœŸã€æ¡æ¬¾å¤±æ§ç­‰å€¾å‘ã€‚å»ºè®®å…ˆè®­ç»ƒä¸å®¡æ‰¹åˆ¶ï¼Œæš‚ç¼“æˆæƒã€‚";

    const bookListHtml = `
      <ul style="margin-top:6px;padding-left:18px;">
        <li><b>è°ˆåˆ¤ï¼š</b>Never Split the Differenceï¼ˆChris Vossï¼‰</li>
        <li><b>åŸåˆ™è°ˆåˆ¤ï¼š</b>Getting to Yesï¼ˆFisher / Uryï¼‰</li>
        <li><b>äº¤ä»˜ä¸ç“¶é¢ˆï¼š</b>The Goalï¼ˆGoldrattï¼‰</li>
        <li><b>å¤æ‚é”€å”®ï¼š</b>The Challenger Sale</li>
        <li><b>é¡¹ç›®ç®¡ç†å…¥é—¨ï¼š</b>PMBOK Guideï¼ˆä½œä¸ºæ¡†æ¶æŸ¥é˜…ç”¨ï¼‰</li>
      </ul>
    `;

    main.innerHTML = `
      <h2>ğŸ“ˆ å¹´åº¦ç»“ç®—ï¼ˆç¬¬ ${session.week} å‘¨ç»“æŸï¼‰</h2>

      <div class="two-col">
        <div>
          <div class="panel">
            <div class="section-title">ç»è¥ç»“æœ</div>
            <div class="stat-row"><span>å®Œæˆè®¢å•</span><span class="stat-val">${completed}</span></div>
            <div class="stat-row"><span>ä¸¢å•/æ”¾å¼ƒ</span><span class="stat-val">${lost}</span></div>
            <div class="stat-row"><span>ç°é‡‘ï¼ˆæ¨¡æ‹Ÿï¼‰</span><span class="stat-val">${formatMoneyUSD(session.resources.cashUSD)}</span></div>
            <div class="stat-row"><span>åº”æ”¶ï¼ˆæ¨¡æ‹Ÿï¼‰</span><span class="stat-val">${formatMoneyUSD(session.resources.receivablesUSD)}</span></div>
          </div>

          <div style="height:12px"></div>

          <div class="panel">
            <div class="section-title">ä¸šåŠ¡èƒ½åŠ›ç”»åƒï¼ˆæ€»åˆ†ï¼š${total}ï¼‰</div>
            ${rows.map(r=>`
              <div class="cap-bar-container">
                <div class="cap-label">${r.label}</div>
                <div class="cap-track">
                  <div class="cap-fill ${r.score<0?"neg":""}" style="width:${clampNumber(50 + r.score*5, 0, 100)}%"></div>
                </div>
                <div style="width:92px;text-align:right;font-size:12px;color:var(--text-muted);">
                  <b style="color:var(--text-main)">${r.score}</b> Â· ${level(r.score)}
                </div>
              </div>
            `).join("")}
          </div>
        </div>

        <div>
          <div class="panel">
            <div class="section-title">ç»¼åˆè¯„ä»·ï¼ˆç»“è®ºï¼‰</div>
            <p class="subtle">${verdict}</p>

            <div style="height:10px"></div>
            <div class="section-title">å»ºè®®ä¸æ”¹è¿›æ–¹å‘</div>
            <ul style="padding-left:18px;">
              ${(advice.length?advice:["æ•´ä½“æ²¡æœ‰æ˜æ˜¾çŸ­æ¿ï¼šå»ºè®®ä¿æŒå¹¶æŠŠç»éªŒæ²‰æ·€ä¸ºæ ‡å‡†åŒ–æ¸…å•/æ¨¡æ¿ï¼ˆæŠ¥ä»·æ¨¡æ¿ã€æ¾„æ¸…æ¸…å•ã€æ¡æ¬¾çº¢çº¿æ¸…å•ã€äº¤ä»˜é‡Œç¨‹ç¢‘ï¼‰ã€‚"])
                .map(a=>`<li class="subtle" style="margin:6px 0;">${a}</li>`).join("")}
            </ul>

            <div style="height:10px"></div>
            <div class="section-title">æ¨èé˜…è¯»ï¼ˆè¡¥çŸ­æ¿ï¼‰</div>
            <div class="subtle">ä¸‹é¢ä¹¦ç›®ä¸ºâ€œèƒ½åŠ›è¡¥å¼ºè·¯çº¿â€ï¼ŒæŒ‰ä½ æœ€å¼±çš„ 2â€“3 é¡¹ä¼˜å…ˆè¯»ï¼š</div>
            ${bookListHtml}

            <div style="margin-top:12px;display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap;">
              <button class="btn btn-outline" onclick="engine.quickSaveToLocal()">ğŸ’¾ ä¿å­˜ç»“ç®—</button>
              <button class="btn btn-primary" onclick="engine.hardReset()">ğŸ” å¼€å¯æ–°å¹´åº¦</button>
            </div>
          </div>
        </div>
      </div>
    `;
  }
};

/* -----------------------------
   7) Small UX hooks
------------------------------ */

// ç‚¹å‡»é®ç½©å…³é—­ï¼ˆç‚¹å¡ç‰‡ä¸å…³é—­ï¼‰
document.getElementById("modal-overlay").addEventListener("click", (e) => {
  if (e.target && e.target.id === "modal-overlay") ui.closeModal();
});

// Esc å…³é—­å¼¹çª—/æ‰‹å†Œ
document.addEventListener("keydown", (e) => {
  if (e.key === "Escape"){
    ui.closeModal();
    document.getElementById("manual-drawer").classList.remove("open");
  }
});

/* -----------------------------
   boot
------------------------------ */
engine.init();

// ğŸ“± æ‰‹æœºç«¯ï¼šç‚¹å‡»ä¸»åŒºåŸŸè‡ªåŠ¨å…³é—­ä¾§æ 
  document.getElementById("main-view").addEventListener("click", () => {
    const aside = document.querySelector("aside");
    if (aside && aside.classList.contains("mobile-open")){
      aside.classList.remove("mobile-open");
    }
  });

</script>

<footer class="app-footer">
  Â© è¥¿å®‰æ³°é‡‘æ–°èƒ½ç§‘æŠ€è‚¡ä»½æœ‰é™å…¬å¸ Â· å¤–è´¸å…¨æµç¨‹æ²™ç›˜æ¨¡æ‹Ÿ v5.0
</footer>

</body>
</html>

